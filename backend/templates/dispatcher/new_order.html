{% extends "dispatcher/base.html" %}

{% block title %}Новый заказ - Taxi 2.0{% endblock %}

{% block extra_head %}
<script src="https://mapgl.2gis.com/api/js/v1?key=a5dd76ec-6e17-4b2a-b65f-e353f1088294"></script>
<script>
    let map;
    let markerA = null;
    let markerB = null;
    let currentTariff = null;
    let currentTariffPrice = 0;
let currentRoute = null;
    
    const tariffPrices = {
        'Эконом': 48,
        'Комфорт': 60,
        'Бизнес': 80
    };
    
function initMap() {
    if (typeof mapgl === 'undefined') {
        console.error('2ГИС MapGL API не загружен');
        return;
    }
    
    const osh = [72.7985, 40.5283];
    
    map = new mapgl.Map('map', {
        center: osh,
        zoom: 12,
        key: 'a5dd76ec-6e17-4b2a-b65f-e353f1088294'
    });
    
    
    map.on('click', function(event) {
        // Получаем координаты клика и проверяем их точность
        const coords = event.lngLat;
        console.log('Клик по карте в координатах:', coords);
        console.log('Тип события:', event.type);
        console.log('Позиция клика на экране:', event.point);
        
        if (!markerA) {
            setPointA(coords);
            reverseGeocode(coords, 'pickup-address');
        } else if (!markerB) {
            setPointB(coords);
            reverseGeocode(coords, 'destination-address');
        } else {
            // Если обе точки уже установлены, сбрасываем и начинаем заново
            resetPoints();
            setPointA(coords);
            reverseGeocode(coords, 'pickup-address');
        }
    });

    initDriverSelect();
    console.log('2ГИС карта инициализирована');
}

function setPointA(coordinates) {
    console.log('setPointA вызвана с координатами:', coordinates);
    console.log('Тип coordinates:', typeof coordinates, 'Array.isArray:', Array.isArray(coordinates));
    
    if (markerA) {
        markerA.destroy();
    }
    
    // Убеждаемся что координаты в правильном формате [lon, lat]
    let coords;
    if (Array.isArray(coordinates)) {
        coords = coordinates;
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lon !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lon, coordinates.lat];
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lng !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lng, coordinates.lat];
    } else {
        console.error('Неправильный формат координат для точки A:', coordinates);
        return;
    }
    
    console.log('Создаем маркер A с координатами:', coords);
    
    markerA = new mapgl.Marker(map, {
        coordinates: coords,
        icon: 'https://docs.2gis.com/img/dotMarker.svg'
    });
    
    if (markerB) {
        calculateRoute();
    }
}
    
function setPointB(coordinates) {
    console.log('setPointB вызвана с координатами:', coordinates);
    console.log('Тип coordinates:', typeof coordinates, 'Array.isArray:', Array.isArray(coordinates));
    
    if (markerB) {
        markerB.destroy();
    }
    
    // Убеждаемся что координаты в правильном формате [lon, lat]
    let coords;
    if (Array.isArray(coordinates)) {
        coords = coordinates;
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lon !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lon, coordinates.lat];
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lng !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lng, coordinates.lat];
    } else {
        console.error('Неправильный формат координат для точки B:', coordinates);
        return;
    }
    
    console.log('Создаем маркер B с координатами:', coords);
    
    markerB = new mapgl.Marker(map, {
        coordinates: coords,
        icon: 'https://docs.2gis.com/img/dotMarker.svg'
    });
    
    if (markerA) {
        calculateRoute();
    }
}

function reverseGeocode(coords, inputId) {
    fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lon=${coords[0]}&lat=${coords[1]}&fields=items.point&key=a5dd76ec-6e17-4b2a-b65f-e353f1088294`)
        .then(response => response.json())
        .then(data => {
            const input = document.getElementById(inputId);
            if (input && data.result && data.result.items && data.result.items.length > 0) {
                input.value = data.result.items[0].full_name || `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            } else if (input) {
                input.value = `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            }
        })
        .catch(error => {
            console.error('Ошибка геокодирования:', error);
        const input = document.getElementById(inputId);
        if (input) {
                input.value = `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            }
        });
}

async function calculateRoute() {
    if (!markerA || !markerB) {
        return;
    }
    
    const coordsA = markerA.getCoordinates();
    const coordsB = markerB.getCoordinates();
    
    if (currentRoute) {
        currentRoute.destroy();
        currentRoute = null;
    }
    
    console.log('Координаты для маршрута:', coordsA, coordsB);
    
    try {
        const requestBody = {
            points: [
                { lat: coordsA[1], lon: coordsA[0] },
                { lat: coordsB[1], lon: coordsB[0] }
            ],
            locale: "ru",
            transport: "driving",
            output: "detailed"
        };
        
        console.log('Отправляем запрос к Routing API:', requestBody);
        
        const response = await fetch('https://routing.api.2gis.com/routing/7.0.0/global?key=a5dd76ec-6e17-4b2a-b65f-e353f1088294', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Ответ от Routing API:', data);
        
        if (data.status === 'OK' && data.result && data.result.length > 0) {
            const route = data.result[0];
            displayRouteInfo(route);
            drawRouteOnMap(route);
        } else {
            console.error('Маршрут не найден:', data);
            displayRouteError();
        }
        
    } catch (error) {
        console.error('Ошибка при запросе к Routing API:', error);
        displayRouteError();
    }
}

function displayRouteInfo(route) {
    console.log('Обрабатываем данные маршрута:', route);
    
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    const priceDisplay = document.getElementById('price-display');
    
    const distance = route.total_distance ? (route.total_distance / 1000) : 0;
    const duration = route.total_duration ? Math.round(route.total_duration / 60) : 0;
    
    console.log('Извлеченные данные - расстояние:', distance, 'км, время:', duration, 'мин');
    
    if (distanceDisplay) {
        distanceDisplay.textContent = `Расстояние: ${distance.toFixed(1)} км`;
    }
    if (durationDisplay) {
        durationDisplay.textContent = `Время: ${duration} мин`;
    }

    if (currentTariff && currentTariffPrice > 0) {
        const price = Math.round(distance * currentTariffPrice);
        if (priceDisplay) {
            priceDisplay.textContent = `Цена: ${price} сом`;
        }
    } else {
        if (priceDisplay) {
            priceDisplay.textContent = 'Цена: выберите водителя';
        }
    }
}

function displayRouteError() {
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    
    if (distanceDisplay) distanceDisplay.textContent = 'Расстояние: ошибка';
    if (durationDisplay) durationDisplay.textContent = 'Время: ошибка';
}

function drawRouteOnMap(route) {
    if (!route.maneuvers || route.maneuvers.length === 0) {
        console.error('Нет данных о маневрах для отрисовки маршрута');
        return;
    }
    
    const coordinates = [];
    
    route.maneuvers.forEach(maneuver => {
        if (maneuver.outcoming_path && maneuver.outcoming_path.geometry) {
            maneuver.outcoming_path.geometry.forEach(geometry => {
                if (geometry.selection) {
                    const linestring = geometry.selection
                        .replace('LINESTRING(', '')
                        .replace(')', '')
                        .split(', ')
                        .map(point => {
                            const [lon, lat] = point.trim().split(' ').map(Number);
                            return [lon, lat];
                        });
                    coordinates.push(...linestring);
                }
            });
        }
    });
    
    if (coordinates.length > 0) {
        console.log('Отрисовываем маршрут с координатами:', coordinates.length, 'точек');
        
        if (currentRoute) {
            currentRoute.destroy();
        }
        
        currentRoute = new mapgl.Polyline(map, {
            coordinates: coordinates,
            width: 4,
            color: '#3b8c4d'
        });
        
        console.log('Маршрут успешно отрисован');
            } else {
        console.error('Не удалось извлечь координаты маршрута');
    }
    }
    
    function initDriverSelect() {
        const driverSelect = document.getElementById('driver-select');
        if (!driverSelect) {
            console.error('Селект водителей не найден');
            return;
        }
        
        driverSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const tariff = selectedOption.getAttribute('data-tariff');
                setDriverTariff(tariff);
            } else {
                clearTariff();
            }
        });
    }

function initAddressAutocomplete() {
    const pickupInput = document.getElementById('pickup-address');
    const destinationInput = document.getElementById('destination-address');
    
    if (pickupInput) {
        setupAutocomplete(pickupInput, 'A');
    }
    if (destinationInput) {
        setupAutocomplete(destinationInput, 'B');
    }
}

function setupAutocomplete(input, pointType) {
    let suggestionsList = null;
    let currentSuggestions = [];
    let selectedIndex = -1;
    
    function createSuggestionsList() {
        suggestionsList = document.createElement('div');
        suggestionsList.className = 'address-suggestions';
        suggestionsList.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        `;
        input.parentNode.style.position = 'relative';
        input.parentNode.appendChild(suggestionsList);
    }
    
    function showSuggestions(suggestions) {
        if (!suggestionsList) createSuggestionsList();
        
        currentSuggestions = suggestions;
        selectedIndex = -1;
        
        if (suggestions.length === 0) {
            suggestionsList.style.display = 'none';
            return;
        }
        
        suggestionsList.innerHTML = '';
        suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.style.cssText = `
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
            `;
            item.textContent = suggestion.full_name || suggestion.address_name;
            
            item.addEventListener('click', () => {
                selectSuggestion(suggestion);
            });
            
            item.addEventListener('mouseenter', () => {
                selectedIndex = index;
                updateSelection();
            });
            
            suggestionsList.appendChild(item);
        });
        
        suggestionsList.style.display = 'block';
    }
    
    function updateSelection() {
        const items = suggestionsList.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#f0f0f0';
            } else {
                item.style.backgroundColor = 'white';
            }
        });
    }
    
    function selectSuggestion(suggestion) {
        input.value = suggestion.full_name || suggestion.address_name;
        suggestionsList.style.display = 'none';
        
        if (suggestion.point && suggestion.point.lat && suggestion.point.lon) {
            const coords = [suggestion.point.lon, suggestion.point.lat];
            
            if (pointType === 'A') {
                setPointA(coords);
            } else {
                setPointB(coords);
            }
        }
    }
    
    let searchTimeout;
    
    input.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            if (suggestionsList) {
                suggestionsList.style.display = 'none';
            }
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchAddresses(query).then(showSuggestions);
        }, 300);
    });
    
    input.addEventListener('keydown', function(e) {
        if (!suggestionsList || suggestionsList.style.display === 'none') return;
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
                    selectSuggestion(currentSuggestions[selectedIndex]);
                }
                break;
            case 'Escape':
                suggestionsList.style.display = 'none';
                break;
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && (!suggestionsList || !suggestionsList.contains(e.target))) {
            if (suggestionsList) {
                suggestionsList.style.display = 'none';
            }
        }
    });
}

async function searchAddresses(query) {
    console.log('Поиск адресов для запроса:', query);
    
    // Используем локальный поиск, который всегда работает
    const localResults = searchLocalAddresses(query);
    
    if (localResults.length > 0) {
        console.log('Найдено локальных результатов:', localResults.length);
        return localResults;
    }
    
    // Если локальный поиск не дал результатов, можно попробовать API (опционально)
    // Пока отключаем API, так как он не работает с текущим ключом
    console.log('Локальные результаты не найдены для запроса:', query);
    return [];
}

function searchLocalAddresses(query) {
    const oshAddresses = [
        // Центральные улицы
        { full_name: 'Ош, улица Ленина, 1', address_name: 'улица Ленина, 1', point: { lat: 40.5228, lon: 72.7889 } },
        { full_name: 'Ош, улица Ленина, 50', address_name: 'улица Ленина, 50', point: { lat: 40.5235, lon: 72.7895 } },
        { full_name: 'Ош, улица Ленина, 100', address_name: 'улица Ленина, 100', point: { lat: 40.5245, lon: 72.7905 } },
        
        { full_name: 'Ош, улица Курманжан Датка, 1', address_name: 'улица Курманжан Датка, 1', point: { lat: 40.5185, lon: 72.8015 } },
        { full_name: 'Ош, улица Курманжан Датка, 25', address_name: 'улица Курманжан Датка, 25', point: { lat: 40.5190, lon: 72.8025 } },
        { full_name: 'Ош, улица Курманжан Датка, 50', address_name: 'улица Курманжан Датка, 50', point: { lat: 40.5195, lon: 72.8035 } },
        
        { full_name: 'Ош, проспект Масалиева, 1', address_name: 'проспект Масалиева, 1', point: { lat: 40.5298, lon: 72.7956 } },
        { full_name: 'Ош, проспект Масалиева, 80', address_name: 'проспект Масалиева, 80', point: { lat: 40.5308, lon: 72.7966 } },
        { full_name: 'Ош, проспект Масалиева, 150', address_name: 'проспект Масалиева, 150', point: { lat: 40.5318, lon: 72.7976 } },
        
        // Другие улицы
        { full_name: 'Ош, улица Исанова, 1', address_name: 'улица Исанова, 1', point: { lat: 40.5156, lon: 72.8142 } },
        { full_name: 'Ош, улица Исанова, 30', address_name: 'улица Исанова, 30', point: { lat: 40.5166, lon: 72.8152 } },
        
        { full_name: 'Ош, улица Навои, 1', address_name: 'улица Навои, 1', point: { lat: 40.5089, lon: 72.8067 } },
        { full_name: 'Ош, улица Навои, 25', address_name: 'улица Навои, 25', point: { lat: 40.5099, lon: 72.8077 } },
        
        { full_name: 'Ош, улица Кыргызстан, 1', address_name: 'улица Кыргызстан, 1', point: { lat: 40.5267, lon: 72.8123 } },
        { full_name: 'Ош, улица Кыргызстан, 40', address_name: 'улица Кыргызстан, 40', point: { lat: 40.5277, lon: 72.8133 } },
        
        { full_name: 'Ош, улица Салиева, 1', address_name: 'улица Салиева, 1', point: { lat: 40.5034, lon: 72.8156 } },
        { full_name: 'Ош, улица Токтогула, 1', address_name: 'улица Токтогула, 1', point: { lat: 40.5123, lon: 72.7934 } },
        
        // Популярные места
        { full_name: 'Ош, Центральный рынок', address_name: 'Центральный рынок', point: { lat: 40.5189, lon: 72.7978 } },
        { full_name: 'Ош, Автовокзал', address_name: 'Автовокзал', point: { lat: 40.5145, lon: 72.8089 } },
        { full_name: 'Ош, Аэропорт', address_name: 'Аэропорт', point: { lat: 40.6089, lon: 72.7934 } },
        { full_name: 'Ош, Университет', address_name: 'Университет', point: { lat: 40.5267, lon: 72.7889 } },
        { full_name: 'Ош, Парк', address_name: 'Парк', point: { lat: 40.5198, lon: 72.8023 } },
        { full_name: 'Ош, Больница', address_name: 'Больница', point: { lat: 40.5156, lon: 72.8067 } },
        
        // Микрорайоны
        { full_name: 'Ош, микрорайон Арча-Бешик', address_name: 'микрорайон Арча-Бешик', point: { lat: 40.5345, lon: 72.8156 } },
        { full_name: 'Ош, микрорайон Кок-Жар', address_name: 'микрорайон Кок-Жар', point: { lat: 40.5089, lon: 72.7823 } },
        { full_name: 'Ош, микрорайон Жайма', address_name: 'микрорайон Жайма', point: { lat: 40.5423, lon: 72.8234 } }
    ];
    
    const normalizedQuery = query.toLowerCase().trim();
    
    return oshAddresses.filter(addr => {
        const fullNameMatch = addr.full_name.toLowerCase().includes(normalizedQuery);
        const addressNameMatch = addr.address_name.toLowerCase().includes(normalizedQuery);
        
        // Также проверяем отдельные слова
        const words = normalizedQuery.split(' ');
        const wordsMatch = words.every(word => 
            word.length < 2 || addr.full_name.toLowerCase().includes(word)
        );
        
        return fullNameMatch || addressNameMatch || wordsMatch;
    }).slice(0, 8); // Ограничиваем до 8 результатов
}
    
    function setDriverTariff(tariff) {
        currentTariff = tariff;
        currentTariffPrice = tariffPrices[tariff] || 0;
        
        const tariffDisplay = document.getElementById('tariff-display');
        if (tariffDisplay) {
            tariffDisplay.textContent = `Тариф: ${tariff} (${currentTariffPrice} сом/км)`;
        }
        
        const tariffSelect = document.getElementById('tariff-select');
        if (tariffSelect) {
            tariffSelect.value = tariff;
        }
        
        if (markerA && markerB) {
            calculateRoute();
        }
    }
    
    function clearTariff() {
        currentTariff = null;
        currentTariffPrice = 0;
        
        const tariffDisplay = document.getElementById('tariff-display');
        if (tariffDisplay) {
            tariffDisplay.textContent = 'Тариф: не выбран';
        }
        
        const tariffSelect = document.getElementById('tariff-select');
        if (tariffSelect) {
            tariffSelect.value = '';
        }
        
        const priceDisplay = document.getElementById('price-display');
        if (priceDisplay) {
            priceDisplay.textContent = 'Цена: 0 сом';
        }
    }
    
    function resetPoints() {
        if (markerA) {
        markerA.destroy();
            markerA = null;
        }
        if (markerB) {
        markerB.destroy();
            markerB = null;
        }
        
    if (currentRoute) {
        currentRoute.destroy();
        currentRoute = null;
    }
        
        const pickupInput = document.getElementById('pickup-address');
        const destinationInput = document.getElementById('destination-address');
        if (pickupInput) pickupInput.value = '';
        if (destinationInput) destinationInput.value = '';
        
        const distanceDisplay = document.getElementById('distance-display');
        const durationDisplay = document.getElementById('duration-display');
        const priceDisplay = document.getElementById('price-display');
        
        if (distanceDisplay) distanceDisplay.textContent = 'Расстояние: 0 км';
        if (durationDisplay) durationDisplay.textContent = 'Время: 0 мин';
        if (priceDisplay) priceDisplay.textContent = 'Цена: 0 сом';
}

document.addEventListener('DOMContentLoaded', function() {
    if (typeof mapgl !== 'undefined') {
        initMap();
    } else {
        setTimeout(initMap, 1000);
    }
    
    initDriverSelect();
    initAddressAutocomplete();
    updateKyrgyzstanTime();
    setInterval(updateKyrgyzstanTime, 1000);
});
</script>
{% endblock %}

{% block page_title %}Новый заказ{% endblock %}

{% block nav_maps_active %}navbar__links-content-active{% endblock %}

{% block header_search %}

{% endblock %}

{% block subheader %}
<div class="main__subheader main__subheader-drivers" style="margin-bottom: 20px;">
    <div class="main__subheader-add">
        <div class="main__header-search-item">
            <button class="main__btn" onclick="createNewOrder()">+ Новый (F2)</button>
        </div>
    </div>
    <div class="main__subheader-drivers">
        <!-- <div class="main__header-tags main__subheader-drivers-tags">
            <ul>
                <li>На линии {{ drivers|length }} водителей</li>
                <li><span class="status-span free"></span> {{ drivers|length }} свободный</li>
                <li><span class="status-span busy"></span> 0 занят</li>
            </ul>
        </div> -->
        <div class="main__subheader-balance">
            <img src="/static/dispatcher/img/ico/balance.png" alt="balance">
            <p>Баланс: {{ "%.0f"|format(balance) if balance else "0" }}</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper" style="border-radius: 5px;">
    <div class="main__order-wrapper-blocks">
        <div class="main__order-settings">
            <div class="main__order-header">
                <div class="main__order-header-item">
                    <p>Заказ №</p>
                    <button class="main__btn-short" id="order-number">{{ order_number }}</button>
                </div>
                <div class="main__order-header-item">
                    <p>Дата время</p>
                    <button class="main__btn-short" id="order-date">{{ current_datetime.strftime('%d.%m.%y') }}</button>
                    <button class="main__btn-short" id="order-time">{{ current_datetime.strftime('%H:%M:%S') }}</button>
                </div>
            </div>
            <div class="main__order-subheader">
                <div class="main__order-subheader-item">
                    <div class="main__subheader-filing">
                        <form action="#">
                            <select name="driver-select" id="driver-select">
                                <option value="" disabled selected>Водители</option>
                                 {% for driver in drivers %}
                                 <option value="{{ driver.id }}" data-tariff="{{ driver.tariff }}">{{ driver.first_name }} {{ driver.last_name }} - {{ driver.phone }}</option>
                                 {% endfor %}
                            </select>
                        </form>
                    </div>
                    <div class="main__subheader-filing">
                        <form action="#">
                            <select name="tariff-select" id="tariff-select">
                                <option value="" disabled selected>Тариф</option>
                                <option value="Эконом">Эконом</option>
                                <option value="Комфорт">Комфорт</option>
                                <option value="Бизнес">Бизнес</option>
                            </select>
                        </form>
                    </div>
                    <div class="main__subheader-filing">
                        <form action="#">
                            <select name="payment-select" id="payment-select">
                                <option value="" disabled selected>Оплата</option>
                                <option value="Наличные">Наличные</option>
                            </select>
                        </form>
                    </div>
                </div>
            </div>
            <div class="main__order-details">
                <div class="main__order-details-item main__order-details-where">
                    <input type="text" placeholder="Точка А (откуда)" id="pickup-address" class="main__order-input">
                </div>
                <div class="main__order-details-item main__order-details-whither">
                    <input type="text" placeholder="Точка Б (куда)" id="destination-address" class="main__order-input">
                </div>
            </div>
            <div class="main__order-notes">
                <div class="main__order-notes-text">
                    <form>
                        <textarea id="order-notes" placeholder="Примечание" class="main__order-input" style="width: 670px;"></textarea>
                    </form>
                </div>
            </div>
            <div class="main__table">
                <table>
                    <thead>
                        <tr>
                            <th>Заказ</th>
                            <th>Время</th>
                            <th>Откуда</th>
                            <th>Куда</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_orders %}
                            {% for order in recent_orders %}
                            <tr>
                                <td>{{ order.id }}</td>
                                <td>{{ order.created_at.strftime('%H:%M %d.%m.%y') if order.created_at else 'Не указано' }}</td>
                                <td>{{ order.pickup_address if order.pickup_address else 'Не указано' }}</td>
                                <td>{{ order.destination_address if order.destination_address else 'Не указано' }}</td>
                                <td>{{ "%.0f"|format(order.price) if order.price else "0" }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: #888;">
                                    Заказов нет
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="main__order-map">
            <div class="main__order-map-item" id="map" style="max-width: 620px;"></div>
            <div class="main__order-map-settings">
                <div class="main__order-map-settings">
                    <button class="main__btn" onclick="resetPoints()">Сбросить точки</button>
                </div>
                <div class="main__order-map-settings-item">
                    <div class="main__btn-short" id="distance-display">Расстояние: 0 км</div>
                    <div class="main__btn-short" id="duration-display">Время: 0 мин</div>
                </div>
                <div class="main__order-map-settings-item">
                    <div class="main__btn-short" id="tariff-display">Тариф: не выбран</div>
                    <div class="main__btn-short" id="price-display">Цена: 0 сом</div>
                </div>
            </div>
        </div>
    </div>
    <div class="main__order-wrapper-btn">
        <button class="main__btn-green" onclick="submitOrder()">Заказать</button>
        <button class="main__btn" onclick="cancelOrder()">Отменить</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function createNewOrder() {
        const newOrderNumber = 'WDD10' + Math.floor(Math.random() * 9000000) + 1000000;
        document.getElementById('order-number').textContent = newOrderNumber;

        const now = new Date();
        document.getElementById('order-date').textContent = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: '2-digit' });

         document.getElementById('driver-select').value = '';
         document.getElementById('tariff-select').value = '';
         document.getElementById('payment-select').value = '';
         document.getElementById('pickup-address').value = '';
         document.getElementById('destination-address').value = '';
         document.getElementById('order-notes').value = '';
         
         if (typeof resetPoints === 'function') {
             resetPoints();
         }
    }
    
    function submitOrder() {
        const orderData = {
            order_number: document.getElementById('order-number').textContent,
            driver_id: document.getElementById('driver-select').value,
            tariff: document.getElementById('tariff-select').value,
            payment_method: document.getElementById('payment-select').value,
            pickup_address: document.getElementById('pickup-address').value,
            destination_address: document.getElementById('destination-address').value,
            notes: document.getElementById('order-notes').value
        };
        
        if (!orderData.driver_id) {
            alert('Выберите водителя');
            return;
        }
        if (!orderData.tariff) {
            alert('Выберите тариф');
            return;
        }
        if (!orderData.payment_method) {
            alert('Выберите способ оплаты');
            return;
        }
        if (!orderData.pickup_address) {
            alert('Введите адрес отправления');
            return;
        }
        if (!orderData.destination_address) {
            alert('Введите адрес назначения');
            return;
        }
        
        if (confirm('Создать заказ?')) {
            fetch('/disp/api/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Заказ успешно создан');
                    location.reload();
                } else {
                    alert('Ошибка при создании заказа: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ошибка при создании заказа');
            });
        }
    }
    
    function cancelOrder() {
        if (confirm('Отменить создание заказа?')) {
            createNewOrder();
        }
    }
    
    async function updateKyrgyzstanTime() {
        try {
            const response = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=Etc/GMT-6');
            const data = await response.json();
            
            if (data.dateTime) {
                const date = new Date(data.dateTime);
                const timeString = date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Etc/GMT-6'
                });
                document.getElementById('order-time').textContent = timeString;
            }
        } catch (error) {
            console.error('Ошибка получения времени:', error);
            // Fallback: вычисляем UTC+6 вручную
            const now = new Date();
            const kyrgyzstanTime = new Date(now.getTime() + (6 * 60 * 60 * 1000)); // UTC+6
            document.getElementById('order-time').textContent = kyrgyzstanTime.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
    }

    updateKyrgyzstanTime(); // Первоначальное обновление
    setInterval(updateKyrgyzstanTime, 1000);
    

     $(document).ready(function() {
         console.log('Страница нового заказа загружена');
         console.log('Номер заказа: {{ order_number }}');
         console.log('Доступно водителей: {{ drivers|length }}');
     });
</script>

<style>
html {
    overflow-y: scroll !important;
}
.main__order-input {
    width: 100%;
    padding: 10px;
    background-color: #47484c;
    border: 1px solid #666;
    border-radius: 4px;
    color: white;
    font-size: 14px;
}

.main__order-input::placeholder {
    color: #999;
}

.main__order-input:focus {
    outline: none;
    border-color: #3b8c4d;
}
.main__order-subheader-item {
    width: 100%;
}
.main__subheader-filing {
    width: 100%;
}
.main__order-subheader-item select {
    width: 100%;
}
 .main__order-header {
     width: 100%;
     justify-content: space-between;
 }

 .main__order-map-settings-item {
    margin: 10px 0;
 }

 #map {
     width: 100%;
     height: 338px;
     border-radius: 5px;
 }

 .tariff-active {
     background-color: #3b8c4d !important;
     color: white !important;
 }
</style>
{% endblock %}
