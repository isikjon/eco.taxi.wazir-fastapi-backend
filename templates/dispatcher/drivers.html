{% extends "dispatcher/base.html" %}

{% block title %}–í–æ–¥–∏—Ç–µ–ª–∏ - Taxi 2.0{% endblock %}

{% block page_title %}–í–æ–¥–∏—Ç–µ–ª–∏{% endblock %}

{% block nav_drivers_active %}navbar__links-content-active{% endblock %}

{% block header_search %}

{% endblock %}

{% block subheader %}
<style>
    .main__btn-short {
        display: flex;
        align-items: center;
    }
</style>
<div class="main__subheader main__subheader-drivers">
    <div class="main__subheader-add">
        <div class="main__header-search-item">
            <form id="search-form" style="background-color: #47484c;">
                <input type="search" id="search-input" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§.–ò.–û" value="{{ filters.search if filters.search else '' }}">
                <button type="submit" style="padding: 0px;"><img src="/static/dispatcher/img/ico/search.png" alt="search"></button>
            </form>
        </div>
        <div class="main__subheader-filing" style="display: flex; gap: 10px;">
            <form method="GET" action="/disp/drivers">
                {% if filters.search %}<input type="hidden" name="search" value="{{ filters.search }}">{% endif %}
                {% if filters.tariff %}<input type="hidden" name="tariff" value="{{ filters.tariff }}">{% endif %}
                <select name="status" onchange="this.form.submit()">
                    <option value="all" {% if filters.status == "all" %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active" {% if filters.status == "active" %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="inactive" {% if filters.status == "inactive" %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                </select>
            </form>
            <form method="GET" action="/disp/drivers">
                {% if filters.search %}<input type="hidden" name="search" value="{{ filters.search }}">{% endif %}
                <input type="hidden" name="status" value="{{ filters.status }}">
                <select name="tariff" onchange="this.form.submit()">
                    <option value="" {% if not filters.tariff %}selected{% endif %}>–í—Å–µ —Ç–∞—Ä–∏—Ñ—ã</option>
                    {% for tariff_option in filter_options.tariffs %}
                    <option value="{{ tariff_option }}" {% if filters.tariff == tariff_option %}selected{% endif %}>{{ tariff_option }}</option>
                    {% endfor %}
                </select>
            </form>
            {% if has_filters %}
            <a href="/disp/drivers" class="main__btn-short">–°–±—Ä–æ—Å–∏—Ç—å</a>
            {% endif %}
        </div>
    </div>
    <div class="main__subheader-drivers">
        <div class="main__subheader-balance">
            <img src="/static/dispatcher/img/ico/balance.png" alt="balance">
            <p>–ë–∞–ª–∞–Ω—Å: {{ "%.0f"|format(balance) if balance else "0" }}</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__drivers-table">
    <div class="main__table main__paybalance-table">
        <table>
            <thead>
                <tr>
                    <th>–°–æ—Å—Ç–æ—è–Ω–∏–µ</th>
                    <th>–ü–æ–∑—ã–≤–Ω–æ–π</th>
                    <th>–§.–ò.–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–ë–∞–ª–∞–Ω—Å</th>
                    <th>–í–£</th>
                </tr>
            </thead>
            <tbody>
                {% if drivers %}
                    {% for driver in drivers %}
                    <tr>
                        <td>
                            <span class="{% if driver.is_active %}status-free{% else %}status-busy{% endif %}">
                                {% if driver.is_active %}–°–≤–æ–±–æ–¥–µ–Ω{% else %}–ó–∞–Ω—è—Ç{% endif %}
                            </span>
                        </td>
                        <td>{{ driver.call_sign if driver.call_sign else "–ù–µ —É–∫–∞–∑–∞–Ω" }}</td>
                        <td>{{ driver.first_name }} {{ driver.last_name }}</td>
                        <td>{{ driver.phone_number }}</td>
                        <td>{{ "%.0f"|format(driver.balance) if driver.balance else "0" }}</td>
                        <td>{{ driver.car_number }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #888;">
                            {% if filters.search %}
                                –ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ filters.search }}" –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                            {% else %}
                                –í–æ–¥–∏—Ç–µ–ª–µ–π –Ω–µ—Ç
                            {% endif %}
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
        <div class="main__table-footer">
            <div class="main__table-driver">
                <button>–í–æ–¥–∏—Ç–µ–ª–∏: {{ total_drivers }}</button>
            </div>
            <div class="main__table-pagination">
                {% if current_page > 1 %}
                <div class="main__table-pagination-prev">
                    <button onclick="goToPage({{ current_page - 1 }})"><img src="/static/dispatcher/img/ico/prev.png" alt="prev"></button>
                </div>
                {% endif %}
                
                {% for page_num in range(1, total_pages + 1) %}
                    {% if page_num == current_page %}
                    <div class="main__table-pagination-active main__table-pagination-item">
                        <button>{{ page_num }}</button>
                    </div>
                    {% else %}
                    <div class="main__table-pagination-item">
                        <button onclick="goToPage({{ page_num }})">{{ page_num }}</button>
                    </div>
                    {% endif %}
                {% endfor %}
                
                {% if current_page < total_pages %}
                <div class="main__table-pagination-next">
                    <button onclick="goToPage({{ current_page + 1 }})"><img src="/static/dispatcher/img/ico/next.png" alt="next"></button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function goToPage(page) {
        const url = new URL(window.location);
        url.searchParams.set('page', page);
        window.location.href = url.toString();
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        
        if (searchForm && searchInput) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const searchValue = searchInput.value.trim();
                
                // –°—Ç—Ä–æ–∏–º URL —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
                const url = new URL(window.location);
                url.searchParams.set('page', '1'); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                
                if (searchValue) {
                    url.searchParams.set('search', searchValue);
                } else {
                    url.searchParams.delete('search');
                }
                
                console.log('üîç DEBUG: Redirecting to:', url.toString());
                window.location.href = url.toString();
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    console.log('üîç DEBUG: Enter pressed, submitting form');
                    searchForm.dispatchEvent(new Event('submit'));
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–æ–∏—Å–∫–∞
            const searchButton = searchForm.querySelector('button[type="submit"]');
            if (searchButton) {
                searchButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('üîç DEBUG: Search button clicked');
                    searchForm.dispatchEvent(new Event('submit'));
                });
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
            function isCyrillic(text) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü—É, –ø—Ä–æ–±–µ–ª—ã –∏ –¥–µ—Ñ–∏—Å—ã
                const cyrillicRegex = /^[–∞-—è—ë\s\-]+$/i;
                return cyrillicRegex.test(text);
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
            let searchTimeout;
            searchInput.addEventListener('input', function(e) {
                const searchValue = e.target.value.trim();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
                if (searchValue && !isCyrillic(searchValue)) {
                    e.target.style.borderColor = '#ff6b6b';
                    e.target.title = '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –∫–∏—Ä–∏–ª–ª–∏—Ü—É (–∞-—è, —ë)';
                } else {
                    e.target.style.borderColor = '';
                    e.target.title = '';
                }
                
                clearTimeout(searchTimeout);
                
                searchTimeout = setTimeout(function() {
                    if (searchValue.length >= 1 || searchValue.length === 0) {
                        console.log('üîç DEBUG: Auto-search triggered for:', searchValue);
                        
                        const url = new URL(window.location);
                        url.searchParams.set('page', '1');
                        
                        if (searchValue) {
                            url.searchParams.set('search', searchValue);
                        } else {
                            url.searchParams.delete('search');
                        }
                        
                        window.location.href = url.toString();
                    }
                }, 500); // –ó–∞–¥–µ—Ä–∂–∫–∞ 500–º—Å
            });
        }
    });
    
    $(document).ready(function() {
        console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        console.log('–¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {{ current_page }}');
        console.log('–í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: {{ total_pages }}');
    });
</script>
{% endblock %}
