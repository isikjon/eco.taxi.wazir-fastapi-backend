{% extends "dispatcher/base.html" %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ - Taxi 2.0{% endblock %}

{% block extra_head %}
<script src="https://mapgl.2gis.com/api/js/v1?key=50ee04cc-386a-4c4a-9fb7-dc3573eceb7e"></script>
<script src="https://unpkg.com/@2gis/mapgl-directions@^2/dist/directions.js"></script>
<script>
    let map;
    let markerA = null;
    let markerB = null;
    let currentTariff = null;
    let currentTariffPrice = 0;
    let currentRoute = null;
    let globalDirections = null;
    
    let pointACoords = null;
    let pointBCoords = null;
    
    let isCalculating = false;
    let isRouteCalculated = false;
    let isPriceCalculated = false;
    
    const tariffPrices = {
        '–≠–∫–æ–Ω–æ–º': 48,
        '–ö–æ–º—Ñ–æ—Ä—Ç': 60,
        '–ë–∏–∑–Ω–µ—Å': 80
    };
    
    function updateOrderButtonState() {
        const orderButton = document.querySelector('.main__btn-green');
        
        const clientName = document.getElementById('client-name').value.trim();
        const clientPhone = document.getElementById('client-phone').value.trim();
        const pickupAddress = document.getElementById('pickup-address').value.trim();
        const destinationAddress = document.getElementById('destination-address').value.trim();
        const orderNotes = document.getElementById('order-notes').value.trim();
        const selectedDriver = document.getElementById('driver-select').value;
        
        const canSubmit = pointACoords && 
                         pointBCoords && 
                         currentTariff && 
                         isRouteCalculated && 
                         isPriceCalculated && 
                         !isCalculating &&
                         clientName &&
                         clientPhone &&
                         pickupAddress &&
                         destinationAddress &&
                         orderNotes &&
                         selectedDriver;
        
        if (orderButton) {
            if (canSubmit) {
                orderButton.disabled = false;
                orderButton.style.opacity = '1';
                orderButton.style.cursor = 'pointer';
                orderButton.textContent = '–ó–∞–∫–∞–∑–∞—Ç—å';
            } else {
                orderButton.disabled = true;
                orderButton.style.opacity = '0.5';
                orderButton.style.cursor = 'not-allowed';
                
                if (isCalculating) {
                    orderButton.textContent = '–†–∞—Å—á–µ—Ç...';
                } else if (!clientName) {
                    orderButton.textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞';
                } else if (!clientPhone) {
                    orderButton.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞';
                } else if (!pickupAddress) {
                    orderButton.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–∫—É –ê';
                } else if (!destinationAddress) {
                    orderButton.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–æ—á–∫—É –ë';
                } else if (!orderNotes) {
                    orderButton.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ';
                } else if (!selectedDriver) {
                    orderButton.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è';
                } else if (!pointACoords || !pointBCoords) {
                    orderButton.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ—á–∫–∏ –ê –∏ –ë –Ω–∞ –∫–∞—Ä—Ç–µ';
                } else if (!isRouteCalculated) {
                    orderButton.textContent = '–†–∞—Å—á–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞...';
                } else if (!isPriceCalculated) {
                    orderButton.textContent = '–†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã...';
                } else {
                    orderButton.textContent = '–ó–∞–∫–∞–∑–∞—Ç—å';
                }
            }
        }
    }
    
function initMap() {
    if (typeof mapgl === 'undefined') {
        console.error('2–ì–ò–° MapGL API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }
    
    const osh = [72.7985, 40.5283];
    
    map = new mapgl.Map('map', {
        center: osh,
        zoom: 13,
        key: '50ee04cc-386a-4c4a-9fb7-dc3573eceb7e',
        locale: 'ru_KG',
        enableTrackResize: true  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ—Å–∞–π–∑ –∫–∞—Ä—Ç—ã
    });
    
    
    map.on('click', function(event) {
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö —Ç–æ—á–Ω–æ—Å—Ç—å
        const coords = event.lngLat;
        console.log('üéØ –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö:', coords);
        console.log('üìç –ü–æ–∑–∏—Ü–∏—è –∫–ª–∏–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω–µ:', event.point);
        console.log('üìè –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–∞—Ä—Ç—ã:', {
            width: document.getElementById('map').offsetWidth,
            height: document.getElementById('map').offsetHeight
        });
        
        if (!markerA) {
            setPointA(coords);
            reverseGeocode(coords, 'pickup-address');
        } else if (!markerB) {
            setPointB(coords);
            reverseGeocode(coords, 'destination-address');
        } else {
            // –ï—Å–ª–∏ –æ–±–µ —Ç–æ—á–∫–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏ –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
            resetPoints();
            setPointA(coords);
            reverseGeocode(coords, 'pickup-address');
        }
    });

    // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions –æ–±—ä–µ–∫—Ç –æ–¥–∏–Ω —Ä–∞–∑
    if (typeof mapgl.Directions !== 'undefined') {
        globalDirections = new mapgl.Directions(map, {
            directionsApiKey: '50ee04cc-386a-4c4a-9fb7-dc3573eceb7e'
        });
        console.log('–ì–ª–æ–±–∞–ª—å–Ω—ã–π Directions API —Å–æ–∑–¥–∞–Ω');
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    setTimeout(() => {
        if (map && typeof map.invalidateSize === 'function') {
            map.invalidateSize();
            console.log('‚úÖ –†–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ invalidateSize()');
        }
    }, 100);

    initDriverSelect();
    console.log('2–ì–ò–° –∫–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –∫–ª–∏–∫–æ–≤ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    setTimeout(() => {
        testMapClickAccuracy();
    }, 500);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏)
function refreshMapSize() {
    if (map && typeof map.invalidateSize === 'function') {
        map.invalidateSize();
        console.log('‚úÖ –†–∞–∑–º–µ—Ä –∫–∞—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é');
        return true;
    } else {
        console.error('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –∏–ª–∏ –º–µ—Ç–æ–¥ invalidateSize –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
        return false;
    }
}

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
window.refreshMapSize = refreshMapSize;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–ª–∏–∫–æ–≤
function testMapClickAccuracy() {
    if (!map) {
        console.error('‚ùå –ö–∞—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        return;
    }
    
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–ª–∏–∫–æ–≤ –∫–∞—Ä—Ç—ã...');
    console.log('üìè –†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', {
        width: document.getElementById('map').offsetWidth,
        height: document.getElementById('map').offsetHeight
    });
    console.log('üó∫Ô∏è –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã:', map.getCenter());
    console.log('üîç –ó—É–º –∫–∞—Ä—Ç—ã:', map.getZoom());
    console.log('üí° –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –∫–æ–Ω—Å–æ–ª–∏');
}

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
window.testMapClickAccuracy = testMapClickAccuracy;

function setPointA(coordinates) {
    console.log('setPointA –≤—ã–∑–≤–∞–Ω–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', coordinates);
    console.log('–¢–∏–ø coordinates:', typeof coordinates, 'Array.isArray:', Array.isArray(coordinates));
    
    if (markerA) {
        markerA.destroy();
    }
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ [lon, lat]
    let coords;
    if (Array.isArray(coordinates)) {
        coords = coordinates;
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lon !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lon, coordinates.lat];
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lng !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lng, coordinates.lat];
    } else {
        console.error('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ç–æ—á–∫–∏ A:', coordinates);
        return;
    }
    
    console.log('–°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä A —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', coords);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    pointACoords = {
        latitude: coords[1],  // lat
        longitude: coords[0]  // lng
    };
    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ A:', pointACoords);
    
    markerA = new mapgl.Marker(map, {
        coordinates: coords,
        icon: 'https://docs.2gis.com/img/dotMarker.svg'
    });
    
    if (markerB) {
        calculateRoute();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    updateOrderButtonState();
}
    
function setPointB(coordinates) {
    console.log('setPointB –≤—ã–∑–≤–∞–Ω–∞ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', coordinates);
    console.log('–¢–∏–ø coordinates:', typeof coordinates, 'Array.isArray:', Array.isArray(coordinates));
    
    if (markerB) {
        markerB.destroy();
    }
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ [lon, lat]
    let coords;
    if (Array.isArray(coordinates)) {
        coords = coordinates;
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lon !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lon, coordinates.lat];
    } else if (coordinates && typeof coordinates === 'object' && coordinates.lng !== undefined && coordinates.lat !== undefined) {
        coords = [coordinates.lng, coordinates.lat];
    } else {
        console.error('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –¥–ª—è —Ç–æ—á–∫–∏ B:', coordinates);
        return;
    }
    
    console.log('–°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä B —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', coords);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    pointBCoords = {
        latitude: coords[1],  // lat
        longitude: coords[0]  // lng
    };
    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ B:', pointBCoords);
    
    markerB = new mapgl.Marker(map, {
        coordinates: coords,
        icon: 'https://docs.2gis.com/img/dotMarker.svg'
    });
    
    if (markerA) {
        calculateRoute();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    updateOrderButtonState();
}

function reverseGeocode(coords, inputId) {
    fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lon=${coords[0]}&lat=${coords[1]}&fields=items.point,items.full_name&key=50ee04cc-386a-4c4a-9fb7-dc3573eceb7e&locale=ru_KG`)
        .then(response => response.json())
        .then(data => {
            const input = document.getElementById(inputId);
            if (input && data.result && data.result.items && data.result.items.length > 0) {
                input.value = data.result.items[0].full_name || `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            } else if (input) {
                input.value = `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            const input = document.getElementById(inputId);
            if (input) {
                input.value = `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            }
        });
}

async function calculateRoute() {
    if (!markerA || !markerB) {
        isRouteCalculated = false;
        isPriceCalculated = false;
        updateOrderButtonState();
        return;
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Ä–∞—Å—á–µ—Ç–∞
    isCalculating = true;
    isRouteCalculated = false;
    isPriceCalculated = false;
    updateOrderButtonState();
    
    const coordsA = markerA.getCoordinates();
    const coordsB = markerB.getCoordinates();
    
    if (currentRoute) {
        if (typeof currentRoute.clear === 'function') {
            currentRoute.clear();
        } else if (typeof currentRoute.destroy === 'function') {
            currentRoute.destroy();
        }
        currentRoute = null;
    }
    
    console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞:', coordsA, coordsB);
    
    try {
        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions API');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions –æ–±—ä–µ–∫—Ç
        if (globalDirections) {
            console.log('–°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions API:', coordsA, coordsB);
            
            // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
            globalDirections.clear();
            
            // –¢–∞–π–º–∞—É—Ç –¥–ª—è Directions API
            let routeBuilt = false;
            const timeout = setTimeout(() => {
                if (!routeBuilt) {
                    console.log('Directions API –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ 3 —Å–µ–∫—É–Ω–¥—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API');
                    calculateDistanceAndTime(coordsA, coordsB);
                }
            }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã —Ç–∞–π–º–∞—É—Ç
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π (–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–π —Ä–∞–∑)
            const onRoute = (result) => {
                routeBuilt = true;
                clearTimeout(timeout);
                console.log('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions API:', result);
                
                // –ü–æ—Å–ª–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                calculateDistanceAndTime(coordsA, coordsB);
                
                // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                globalDirections.off('route', onRoute);
                globalDirections.off('error', onError);
            };
            
            const onError = (err) => {
                routeBuilt = true;
                clearTimeout(timeout);
                console.error('–û—à–∏–±–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ Directions API:', err);
                // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API
                calculateDistanceAndTime(coordsA, coordsB);
                
                // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                globalDirections.off('route', onRoute);
                globalDirections.off('error', onError);
            };
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            globalDirections.on('route', onRoute);
            globalDirections.on('error', onError);
            
            // –°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç
            globalDirections.carRoute({
                points: [
                    [coordsA[0], coordsA[1]], // [lon, lat]
                    [coordsB[0], coordsB[1]]  // [lon, lat]
                ]
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π directions
            currentRoute = globalDirections;
            console.log('currentRoute —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions');
            
        } else {
            console.log('–ì–ª–æ–±–∞–ª—å–Ω—ã–π Directions API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API –Ω–∞–ø—Ä—è–º—É—é
            calculateDistanceAndTime(coordsA, coordsB);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
        // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API
        calculateDistanceAndTime(coordsA, coordsB);
    }
}

async function calculateDistanceAndTime(coordsA, coordsB) {
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º Distance Matrix API –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∏ –≤—Ä–µ–º–µ–Ω–∏');
    
    try {
        const requestBody = {
            origins: [
                {
                    lat: coordsA[1],
                    lon: coordsA[0]
                }
            ],
            destinations: [
                {
                    lat: coordsB[1],
                    lon: coordsB[0]
                }
            ],
            transport: "car",
            type: "shortest"
        };
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Distance Matrix API:', requestBody);
        
        const response = await fetch('https://routing.api.2gis.com/routing/7.0.0/global?key=50ee04cc-386a-4c4a-9fb7-dc3573eceb7e', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                points: [
                    {
                        type: "pedo",
                        lat: coordsA[1],
                        lon: coordsA[0]
                    },
                    {
                        type: "pedo", 
                        lat: coordsB[1],
                        lon: coordsB[0]
                    }
                ],
                transport: "car",
                route_mode: "fastest"
            })
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ Distance Matrix API:', response.status, errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('–û—Ç–≤–µ—Ç –æ—Ç Routing API:', data);
        
        if (data && data.result && data.result.length > 0) {
            const route = data.result[0];
            displayRouteInfoFromRoutingAPI(route);
            // –ù–ï —Ä–∏—Å—É–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Directions API –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Directions API');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤
            isCalculating = false;
            isRouteCalculated = true;
            isPriceCalculated = true;
            updateOrderButtonState();
        } else {
            console.error('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ Routing API:', data);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É - –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            displayRouteError();
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç 2–ì–ò–°');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –æ—à–∏–±–∫–∏
            isCalculating = false;
            isRouteCalculated = false;
            isPriceCalculated = false;
            updateOrderButtonState();
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ Distance Matrix API:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É - –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        displayRouteError();
        console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç 2–ì–ò–°');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –æ—à–∏–±–∫–∏
        isCalculating = false;
        isRouteCalculated = false;
        isPriceCalculated = false;
        updateOrderButtonState();
    }
}

function displayRouteInfoFromDistanceMatrix(route) {
    console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ Distance Matrix API:', route);
    
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    const priceDisplay = document.getElementById('price-display');
    
    // Distance Matrix API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª—è—Ö distance (–º–µ—Ç—Ä—ã) –∏ duration (—Å–µ–∫—É–Ω–¥—ã)
    const distance = route.distance ? (route.distance / 1000) : 0; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–º
    const duration = route.duration ? Math.round(route.duration / 60) : 0; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –º–∏–Ω—É—Ç—ã
    
    console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance, '–∫–º, –≤—Ä–µ–º—è:', duration, '–º–∏–Ω');
    
    if (distanceDisplay) {
        distanceDisplay.textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`;
    }
    if (durationDisplay) {
        durationDisplay.textContent = `–í—Ä–µ–º—è: ${duration} –º–∏–Ω`;
    }

    if (currentTariff && currentTariffPrice > 0) {
        const price = Math.round(distance * currentTariffPrice);
        if (priceDisplay) {
            priceDisplay.textContent = `–¶–µ–Ω–∞: ${price} —Å–æ–º`;
        }
    } else {
        if (priceDisplay) {
            priceDisplay.textContent = '–¶–µ–Ω–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è';
        }
    }
}

function displaySimpleRouteInfo(distance, duration) {
    console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance, '–∫–º, –≤—Ä–µ–º—è:', duration, '–º–∏–Ω');
    
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    const priceDisplay = document.getElementById('price-display');
    
    if (distanceDisplay) {
        distanceDisplay.textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ~${distance.toFixed(1)} –∫–º`;
    }
    if (durationDisplay) {
        durationDisplay.textContent = `–í—Ä–µ–º—è: ~${duration} –º–∏–Ω`;
    }

    if (currentTariff && currentTariffPrice > 0) {
        const price = Math.round(distance * currentTariffPrice);
        if (priceDisplay) {
            priceDisplay.textContent = `–¶–µ–Ω–∞: ~${price} —Å–æ–º`;
        }
    } else {
        if (priceDisplay) {
            priceDisplay.textContent = '–¶–µ–Ω–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è';
        }
    }
}

function drawSimpleRoute(coordsA, coordsB) {
    console.log('–†–∏—Å—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ª–∏–Ω–∏—é –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏');
    
    if (currentRoute) {
        if (typeof currentRoute.destroy === 'function') {
            currentRoute.destroy();
        } else if (typeof currentRoute.remove === 'function') {
            currentRoute.remove();
        }
        currentRoute = null;
    }
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –ª–∏–Ω–∏—é –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
    const polyline = new mapgl.Polyline(map, {
        coordinates: [coordsA, coordsB],
        color: '#028eff',
        width: 4
    });
    
    currentRoute = polyline;
    
    // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –æ–±–µ —Ç–æ—á–∫–∏
    map.fitBounds({
        northEast: [Math.max(coordsA[0], coordsB[0]), Math.max(coordsA[1], coordsB[1])],
        southWest: [Math.min(coordsA[0], coordsB[0]), Math.min(coordsA[1], coordsB[1])]
    });
}

function calculateDistance(coord1, coord2) {
    const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
    const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
    const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) *
        Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function displayRouteInfo(route) {
    console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞:', route);
    
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    const priceDisplay = document.getElementById('price-display');
    
    const distance = route.total_distance ? (route.total_distance / 1000) : 0;
    const duration = route.total_duration ? Math.round(route.total_duration / 60) : 0;
    
    console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance, '–∫–º, –≤—Ä–µ–º—è:', duration, '–º–∏–Ω');
    
    if (distanceDisplay) {
        distanceDisplay.textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`;
    }
    if (durationDisplay) {
        durationDisplay.textContent = `–í—Ä–µ–º—è: ${duration} –º–∏–Ω`;
    }

    if (currentTariff && currentTariffPrice > 0) {
        const price = Math.round(distance * currentTariffPrice);
        if (priceDisplay) {
            priceDisplay.textContent = `–¶–µ–Ω–∞: ${price} —Å–æ–º`;
        }
    } else {
        if (priceDisplay) {
            priceDisplay.textContent = '–¶–µ–Ω–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è';
        }
    }
}

function displayRouteInfoFromDirections(route) {
    console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ Directions API:', route);
    
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    const priceDisplay = document.getElementById('price-display');
    
    // Directions API –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—è—Ö
    let distance = 0;
    let duration = 0;
    
    if (route.distance) {
        distance = route.distance / 1000; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Ç—Ä—ã –≤ –∫–º
    } else if (route.total_distance) {
        distance = route.total_distance / 1000;
    }
    
    if (route.duration) {
        duration = Math.round(route.duration / 60); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ –º–∏–Ω—É—Ç—ã
    } else if (route.total_duration) {
        duration = Math.round(route.total_duration / 60);
    }
    
    console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance, '–∫–º, –≤—Ä–µ–º—è:', duration, '–º–∏–Ω');
    
    if (distanceDisplay) {
        distanceDisplay.textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`;
    }
    if (durationDisplay) {
        durationDisplay.textContent = `–í—Ä–µ–º—è: ${duration} –º–∏–Ω`;
    }

    if (currentTariff && currentTariffPrice > 0) {
        const price = Math.round(distance * currentTariffPrice);
        if (priceDisplay) {
            priceDisplay.textContent = `–¶–µ–Ω–∞: ${price} —Å–æ–º`;
        }
    } else {
        if (priceDisplay) {
            priceDisplay.textContent = '–¶–µ–Ω–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è';
        }
    }
}

function displayRouteError() {
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    
    if (distanceDisplay) distanceDisplay.textContent = '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: –æ—à–∏–±–∫–∞';
    if (durationDisplay) durationDisplay.textContent = '–í—Ä–µ–º—è: –æ—à–∏–±–∫–∞';
}

function drawRouteOnMap(route) {
    if (!route.maneuvers || route.maneuvers.length === 0) {
        console.error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞–Ω–µ–≤—Ä–∞—Ö –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞');
        return;
    }
    
    const coordinates = [];
    
    route.maneuvers.forEach(maneuver => {
        if (maneuver.outcoming_path && maneuver.outcoming_path.geometry) {
            maneuver.outcoming_path.geometry.forEach(geometry => {
                if (geometry.selection) {
                    const linestring = geometry.selection
                        .replace('LINESTRING(', '')
                        .replace(')', '')
                        .split(', ')
                        .map(point => {
                            const [lon, lat] = point.trim().split(' ').map(Number);
                            return [lon, lat];
                        });
                    coordinates.push(...linestring);
                }
            });
        }
    });
    
    if (coordinates.length > 0) {
        console.log('–û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:', coordinates.length, '—Ç–æ—á–µ–∫');
        
        if (currentRoute) {
            currentRoute.destroy();
        }
        
        currentRoute = new mapgl.Polyline(map, {
            coordinates: coordinates,
            width: 4,
            color: '#3b8c4d'
        });
        
        console.log('–ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω');
            } else {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞');
    }
    }
    
    function initDriverSelect() {
        const driverSelect = document.getElementById('driver-select');
        if (!driverSelect) {
            console.error('–°–µ–ª–µ–∫—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        driverSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const tariff = selectedOption.getAttribute('data-tariff');
                setDriverTariff(tariff);
            } else {
                clearTariff();
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
            updateOrderButtonState();
        });
    }

function initAddressAutocomplete() {
    const pickupInput = document.getElementById('pickup-address');
    const destinationInput = document.getElementById('destination-address');
    
    if (pickupInput) {
        setupAutocomplete(pickupInput, 'A');
    }
    if (destinationInput) {
        setupAutocomplete(destinationInput, 'B');
    }
}

function setupAutocomplete(input, pointType) {
    let suggestionsList = null;
    let currentSuggestions = [];
    let selectedIndex = -1;
    
    function createSuggestionsList() {
        suggestionsList = document.createElement('div');
        suggestionsList.className = 'address-suggestions';
        suggestionsList.style.cssText = `
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        `;
        input.parentNode.style.position = 'relative';
        input.parentNode.appendChild(suggestionsList);
    }
    
    function showSuggestions(suggestions) {
        if (!suggestionsList) createSuggestionsList();
        
        currentSuggestions = suggestions;
        selectedIndex = -1;
        
        if (suggestions.length === 0) {
            suggestionsList.style.display = 'none';
            return;
        }
        
        suggestionsList.innerHTML = '';
        suggestions.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.style.cssText = `
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
            `;
            item.textContent = suggestion.full_name || suggestion.address_name;
            
            item.addEventListener('click', () => {
                selectSuggestion(suggestion);
            });
            
            item.addEventListener('mouseenter', () => {
                selectedIndex = index;
                updateSelection();
            });
            
            suggestionsList.appendChild(item);
        });
        
        suggestionsList.style.display = 'block';
    }
    
    function updateSelection() {
        const items = suggestionsList.querySelectorAll('.suggestion-item');
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#f0f0f0';
            } else {
                item.style.backgroundColor = 'white';
            }
        });
    }
    
    function selectSuggestion(suggestion) {
        input.value = suggestion.full_name || suggestion.address_name;
        suggestionsList.style.display = 'none';
        
        if (suggestion.point && suggestion.point.lat && suggestion.point.lon) {
            const coords = [suggestion.point.lon, suggestion.point.lat];
            
            if (pointType === 'A') {
                setPointA(coords);
            } else {
                setPointB(coords);
            }
        }
    }
    
    let searchTimeout;
    
    input.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            if (suggestionsList) {
                suggestionsList.style.display = 'none';
            }
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchAddresses(query).then(showSuggestions);
        }, 300);
    });
    
    input.addEventListener('keydown', function(e) {
        if (!suggestionsList || suggestionsList.style.display === 'none') return;
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                updateSelection();
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection();
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
                    selectSuggestion(currentSuggestions[selectedIndex]);
                }
                break;
            case 'Escape':
                suggestionsList.style.display = 'none';
                break;
        }
    });
    
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && (!suggestionsList || !suggestionsList.contains(e.target))) {
            if (suggestionsList) {
                suggestionsList.style.display = 'none';
            }
        }
    });
}

async function searchAddresses(query) {
    console.log('–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:', query);
    
    if (!query || query.length < 2) {
        return [];
    }
    
    try {
        // –ü–æ–∏—Å–∫ —á–µ—Ä–µ–∑ 2–ì–ò–° API —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω—É
        const kyrgyzstanBounds = {
            point1: "69.0,43.3",  // –°–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
            point2: "80.3,39.2"   // –Æ–≥–æ-–≤–æ—Å—Ç–æ–∫ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω–∞
        };
        
        const apiUrl = `https://catalog.api.2gis.com/3.0/items?key=50ee04cc-386a-4c4a-9fb7-dc3573eceb7e&q=${encodeURIComponent(query)}&point1=${kyrgyzstanBounds.point1}&point2=${kyrgyzstanBounds.point2}&locale=ru_KG&fields=items.point,items.name,items.full_name&limit=10`;
        
        const response = await fetch(apiUrl);
        const data = await response.json();
        
        if (data.result && data.result.items) {
            const apiResults = data.result.items.map(item => ({
                full_name: item.full_name || item.name,
                address_name: item.name,
                point: {
                    lat: item.point.lat,
                    lon: item.point.lon
                }
            }));
            
            console.log('–ù–∞–π–¥–µ–Ω–æ API —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', apiResults.length);
            return apiResults;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ API –ø–æ–∏—Å–∫–∞:', error);
    }
    
    // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
    const localResults = searchLocalAddresses(query);
    if (localResults.length > 0) {
        console.log('–ù–∞–π–¥–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', localResults.length);
        return localResults;
    }
    
    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞:', query);
    return [];
}

function searchLocalAddresses(query) {
    const oshAddresses = [
        // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–µ —É–ª–∏—Ü—ã
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 1', address_name: '—É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 1', point: { lat: 40.5228, lon: 72.7889 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 50', address_name: '—É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 50', point: { lat: 40.5235, lon: 72.7895 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 100', address_name: '—É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞, 100', point: { lat: 40.5245, lon: 72.7905 } },
        
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞, 1', address_name: '—É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞, 1', point: { lat: 40.5185, lon: 72.8015 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞, 25', address_name: '—É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞, 25', point: { lat: 40.5190, lon: 72.8025 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞, 50', address_name: '—É–ª–∏—Ü–∞ –ö—É—Ä–º–∞–Ω–∂–∞–Ω –î–∞—Ç–∫–∞, 50', point: { lat: 40.5195, lon: 72.8035 } },
        
        { full_name: '–û—à, –ø—Ä–æ—Å–ø–µ–∫—Ç –ú–∞—Å–∞–ª–∏–µ–≤–∞, 1', address_name: '–ø—Ä–æ—Å–ø–µ–∫—Ç –ú–∞—Å–∞–ª–∏–µ–≤–∞, 1', point: { lat: 40.5298, lon: 72.7956 } },
        { full_name: '–û—à, –ø—Ä–æ—Å–ø–µ–∫—Ç –ú–∞—Å–∞–ª–∏–µ–≤–∞, 80', address_name: '–ø—Ä–æ—Å–ø–µ–∫—Ç –ú–∞—Å–∞–ª–∏–µ–≤–∞, 80', point: { lat: 40.5308, lon: 72.7966 } },
        { full_name: '–û—à, –ø—Ä–æ—Å–ø–µ–∫—Ç –ú–∞—Å–∞–ª–∏–µ–≤–∞, 150', address_name: '–ø—Ä–æ—Å–ø–µ–∫—Ç –ú–∞—Å–∞–ª–∏–µ–≤–∞, 150', point: { lat: 40.5318, lon: 72.7976 } },
        
        // –î—Ä—É–≥–∏–µ —É–ª–∏—Ü—ã
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ò—Å–∞–Ω–æ–≤–∞, 1', address_name: '—É–ª–∏—Ü–∞ –ò—Å–∞–Ω–æ–≤–∞, 1', point: { lat: 40.5156, lon: 72.8142 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ò—Å–∞–Ω–æ–≤–∞, 30', address_name: '—É–ª–∏—Ü–∞ –ò—Å–∞–Ω–æ–≤–∞, 30', point: { lat: 40.5166, lon: 72.8152 } },
        
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ù–∞–≤–æ–∏, 1', address_name: '—É–ª–∏—Ü–∞ –ù–∞–≤–æ–∏, 1', point: { lat: 40.5089, lon: 72.8067 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ù–∞–≤–æ–∏, 25', address_name: '—É–ª–∏—Ü–∞ –ù–∞–≤–æ–∏, 25', point: { lat: 40.5099, lon: 72.8077 } },
        
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω, 1', address_name: '—É–ª–∏—Ü–∞ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω, 1', point: { lat: 40.5267, lon: 72.8123 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω, 40', address_name: '—É–ª–∏—Ü–∞ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω, 40', point: { lat: 40.5277, lon: 72.8133 } },
        
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –°–∞–ª–∏–µ–≤–∞, 1', address_name: '—É–ª–∏—Ü–∞ –°–∞–ª–∏–µ–≤–∞, 1', point: { lat: 40.5034, lon: 72.8156 } },
        { full_name: '–û—à, —É–ª–∏—Ü–∞ –¢–æ–∫—Ç–æ–≥—É–ª–∞, 1', address_name: '—É–ª–∏—Ü–∞ –¢–æ–∫—Ç–æ–≥—É–ª–∞, 1', point: { lat: 40.5123, lon: 72.7934 } },
        
        // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–µ—Å—Ç–∞
        { full_name: '–û—à, –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫', address_name: '–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫', point: { lat: 40.5189, lon: 72.7978 } },
        { full_name: '–û—à, –ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª', address_name: '–ê–≤—Ç–æ–≤–æ–∫–∑–∞–ª', point: { lat: 40.5145, lon: 72.8089 } },
        { full_name: '–û—à, –ê—ç—Ä–æ–ø–æ—Ä—Ç', address_name: '–ê—ç—Ä–æ–ø–æ—Ä—Ç', point: { lat: 40.6089, lon: 72.7934 } },
        { full_name: '–û—à, –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', address_name: '–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç', point: { lat: 40.5267, lon: 72.7889 } },
        { full_name: '–û—à, –ü–∞—Ä–∫', address_name: '–ü–∞—Ä–∫', point: { lat: 40.5198, lon: 72.8023 } },
        { full_name: '–û—à, –ë–æ–ª—å–Ω–∏—Ü–∞', address_name: '–ë–æ–ª—å–Ω–∏—Ü–∞', point: { lat: 40.5156, lon: 72.8067 } },
        
        // –ú–∏–∫—Ä–æ—Ä–∞–π–æ–Ω—ã
        { full_name: '–û—à, –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ê—Ä—á–∞-–ë–µ—à–∏–∫', address_name: '–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ê—Ä—á–∞-–ë–µ—à–∏–∫', point: { lat: 40.5345, lon: 72.8156 } },
        { full_name: '–û—à, –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ö–æ–∫-–ñ–∞—Ä', address_name: '–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ö–æ–∫-–ñ–∞—Ä', point: { lat: 40.5089, lon: 72.7823 } },
        { full_name: '–û—à, –º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ñ–∞–π–º–∞', address_name: '–º–∏–∫—Ä–æ—Ä–∞–π–æ–Ω –ñ–∞–π–º–∞', point: { lat: 40.5423, lon: 72.8234 } }
    ];
    
    const normalizedQuery = query.toLowerCase().trim();
    
    return oshAddresses.filter(addr => {
        const fullNameMatch = addr.full_name.toLowerCase().includes(normalizedQuery);
        const addressNameMatch = addr.address_name.toLowerCase().includes(normalizedQuery);
        
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
        const words = normalizedQuery.split(' ');
        const wordsMatch = words.every(word => 
            word.length < 2 || addr.full_name.toLowerCase().includes(word)
        );
        
        return fullNameMatch || addressNameMatch || wordsMatch;
    }).slice(0, 8); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 8 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
}
    
    function setDriverTariff(tariff) {
        currentTariff = tariff;
        currentTariffPrice = tariffPrices[tariff] || 0;
        
        const tariffDisplay = document.getElementById('tariff-display');
        if (tariffDisplay) {
            tariffDisplay.textContent = `–¢–∞—Ä–∏—Ñ: ${tariff} (${currentTariffPrice} —Å–æ–º/–∫–º)`;
        }
        
        const tariffSelect = document.getElementById('tariff-select');
        if (tariffSelect) {
            tariffSelect.value = tariff;
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≤–æ–¥–∏—Ç–µ–ª—è
            tariffSelect.disabled = true;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ —Ä–∞—Å—á–µ—Ç–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–æ–¥–∏—Ç–µ–ª—è
        isPriceCalculated = false;
        updateOrderButtonState();
        
        if (markerA && markerB) {
            calculateRoute();
        }
    }
    
    function clearTariff() {
        currentTariff = null;
        currentTariffPrice = 0;
        
        const tariffDisplay = document.getElementById('tariff-display');
        if (tariffDisplay) {
            tariffDisplay.textContent = '–¢–∞—Ä–∏—Ñ: –Ω–µ –≤—ã–±—Ä–∞–Ω';
        }
        
        const tariffSelect = document.getElementById('tariff-select');
        if (tariffSelect) {
            tariffSelect.value = '';
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
            tariffSelect.disabled = false;
        }
        
        const priceDisplay = document.getElementById('price-display');
        if (priceDisplay) {
            priceDisplay.textContent = '–¶–µ–Ω–∞: 0 —Å–æ–º';
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ —Ä–∞—Å—á–µ—Ç–æ–≤
        isPriceCalculated = false;
        updateOrderButtonState();
    }
    
    function resetPoints() {
        if (markerA) {
            markerA.destroy();
            markerA = null;
            console.log('–ú–∞—Ä–∫–µ—Ä A —É–¥–∞–ª–µ–Ω');
        }
        if (markerB) {
            markerB.destroy();
            markerB = null;
            console.log('–ú–∞—Ä–∫–µ—Ä B —É–¥–∞–ª–µ–Ω');
        }
        
    // –°–±—Ä–æ—Å –º–∞—Ä—à—Ä—É—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions API
    if (globalDirections) {
        console.log('–°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π Directions API');
        try {
            globalDirections.clear();
            console.log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç —Å–±—Ä–æ—à–µ–Ω –º–µ—Ç–æ–¥–æ–º clear() (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± 2–ì–ò–°)');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
        }
    }
    
    // –û–±–Ω—É–ª—è–µ–º currentRoute
    currentRoute = null;
    console.log('currentRoute –æ–±–Ω—É–ª–µ–Ω');
    
    // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    pointACoords = null;
    pointBCoords = null;
    console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ –æ—á–∏—â–µ–Ω—ã');
        
        const pickupInput = document.getElementById('pickup-address');
        const destinationInput = document.getElementById('destination-address');
        if (pickupInput) pickupInput.value = '';
        if (destinationInput) destinationInput.value = '';
        
        const distanceDisplay = document.getElementById('distance-display');
        const durationDisplay = document.getElementById('duration-display');
        const priceDisplay = document.getElementById('price-display');
        
        if (distanceDisplay) distanceDisplay.textContent = '–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º';
        if (durationDisplay) durationDisplay.textContent = '–í—Ä–µ–º—è: 0 –º–∏–Ω';
        if (priceDisplay) priceDisplay.textContent = '–¶–µ–Ω–∞: 0 —Å–æ–º';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–ª–∞–≥–∏ —Ä–∞—Å—á–µ—Ç–æ–≤
        isCalculating = false;
        isRouteCalculated = false;
        isPriceCalculated = false;
        updateOrderButtonState();
}

// –§—É–Ω–∫—Ü–∏—è –º–∞—Å–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function initPhoneMask() {
    const phoneInput = document.getElementById('client-phone');
    if (!phoneInput) return;
    
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–µ—Ü–∏—Ñ—Ä–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
        
        // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–µ —Å 996, –¥–æ–±–∞–≤–ª—è–µ–º 996
        if (value.length > 0 && !value.startsWith('996')) {
            value = '996' + value;
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 14 —Ü–∏—Ñ—Ä (996 + 11 —Ü–∏—Ñ—Ä)
        if (value.length > 14) {
            value = value.substring(0, 14);
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤ +996 XXX - XXX - XXXX
        let formatted = '';
        if (value.length > 0) {
            formatted = '+996';
            if (value.length > 3) {
                formatted += ' ' + value.substring(3, 6);
            }
            if (value.length > 6) {
                formatted += ' - ' + value.substring(6, 9);
            }
            if (value.length > 9) {
                formatted += ' - ' + value.substring(9, 14);
            }
        }
        
        e.target.value = formatted;
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à Backspace –∏ Delete
    phoneInput.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' || e.key === 'Delete') {
            // –†–∞–∑—Ä–µ—à–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
            return true;
        }
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏
        if (!/\d/.test(e.key) && !['Tab', 'Enter', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(e.key)) {
            e.preventDefault();
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    if (typeof mapgl !== 'undefined') {
        initMap();
    } else {
        setTimeout(initMap, 1000);
    }
    
    initDriverSelect();
    initAddressAutocomplete();
    initPhoneMask();
    updateKyrgyzstanTime();
    setInterval(updateKyrgyzstanTime, 1000);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    updateOrderButtonState();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª–µ–π
    initFieldHandlers();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
function initFieldHandlers() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const fields = [
        'client-name',
        'client-phone', 
        'pickup-address',
        'destination-address',
        'order-notes'
    ];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏—è input (–≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞)
            field.addEventListener('input', updateOrderButtonState);
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏—è change (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)
            field.addEventListener('change', updateOrderButtonState);
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏—è blur (–ø–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞)
            field.addEventListener('blur', updateOrderButtonState);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–µ–ª–µ–∫—Ç–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
    const driverSelect = document.getElementById('driver-select');
    if (driverSelect) {
        driverSelect.addEventListener('change', updateOrderButtonState);
    }
}

function displayRouteInfoFromRoutingAPI(route) {
    console.log('–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ Routing API:', route);
    
    const distanceDisplay = document.getElementById('distance-display');
    const durationDisplay = document.getElementById('duration-display');
    const priceDisplay = document.getElementById('price-display');
    
    // Routing API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª—è—Ö total_distance –∏ total_duration
    const distance = route.total_distance ? (route.total_distance / 1000) : 0;
    const duration = route.total_duration ? Math.round(route.total_duration / 60) : 0;
    
    console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Routing API - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance, '–∫–º, –≤—Ä–µ–º—è:', duration, '–º–∏–Ω');
    
    if (distanceDisplay) {
        distanceDisplay.textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance.toFixed(1)} –∫–º`;
    }
    if (durationDisplay) {
        durationDisplay.textContent = `–í—Ä–µ–º—è: ${duration} –º–∏–Ω`;
    }

    if (currentTariff && currentTariffPrice > 0) {
        const price = Math.round(distance * currentTariffPrice);
        if (priceDisplay) {
            priceDisplay.textContent = `–¶–µ–Ω–∞: ${price} —Å–æ–º`;
        }
    } else {
        if (priceDisplay) {
            priceDisplay.textContent = '–¶–µ–Ω–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è';
        }
    }
}

function drawRouteFromGeometry(geometry) {
    console.log('–†–∏—Å—É–µ–º –º–∞—Ä—à—Ä—É—Ç –∏–∑ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ Routing API');
    
    if (currentRoute) {
        if (typeof currentRoute.destroy === 'function') {
            currentRoute.destroy();
        } else if (typeof currentRoute.remove === 'function') {
            currentRoute.remove();
        }
        currentRoute = null;
    }
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è MapGL
    const coordinates = [];
    for (let i = 0; i < geometry.length; i += 2) {
        coordinates.push([geometry[i], geometry[i + 1]]); // [lon, lat]
    }
    
    console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞:', coordinates.length, '—Ç–æ—á–µ–∫');
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏–ª–∏–Ω–∏—é
    const polyline = new mapgl.Polyline(map, {
        coordinates: coordinates,
        color: '#028eff',
        width: 4
    });
    
    currentRoute = polyline;
    console.log('currentRoute —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ Polyline:', currentRoute.constructor.name);
    
    // –ü–æ–¥–≥–æ–Ω—è–µ–º –∫–∞—Ä—Ç—É –ø–æ–¥ –º–∞—Ä—à—Ä—É—Ç
    if (coordinates.length > 0) {
        const bounds = {
            northEast: [
                Math.max(...coordinates.map(c => c[0])),
                Math.max(...coordinates.map(c => c[1]))
            ],
            southWest: [
                Math.min(...coordinates.map(c => c[0])),
                Math.min(...coordinates.map(c => c[1]))
            ]
        };
        
        map.fitBounds(bounds, { padding: 50 });
    }
}

</script>
{% endblock %}

{% block page_title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑{% endblock %}

{% block nav_maps_active %}navbar__links-content-active{% endblock %}

{% block header_search %}

{% endblock %}

{% block subheader %}
<div class="main__subheader main__subheader-drivers" style="margin-bottom: 20px;">
    <div class="main__subheader-add">
        <div class="main__header-search-item">
            <button class="main__btn" onclick="createNewOrder()">+ –ù–æ–≤—ã–π (F2)</button>
        </div>
    </div>
    <div class="main__subheader-drivers">
        <!-- <div class="main__header-tags main__subheader-drivers-tags">
            <ul>
                <li>–ù–∞ –ª–∏–Ω–∏–∏ {{ drivers|length }} –≤–æ–¥–∏—Ç–µ–ª–µ–π</li>
                <li><span class="status-span free"></span> {{ drivers|length }} —Å–≤–æ–±–æ–¥–Ω—ã–π</li>
                <li><span class="status-span busy"></span> 0 –∑–∞–Ω—è—Ç</li>
            </ul>
        </div> -->
        <div class="main__subheader-balance">
            <img src="/static/dispatcher/img/ico/balance.png" alt="balance">
            <p>–ë–∞–ª–∞–Ω—Å: {{ "%.0f"|format(balance) if balance else "0" }}</p>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="main__order-wrapper" style="border-radius: 5px;">
    <div class="main__order-wrapper-blocks">
        <div class="main__order-settings">
            <div class="main__order-header">
                <div class="main__order-header-item">
                    <p>–ó–∞–∫–∞–∑ ‚Ññ</p>
                    <button class="main__btn-short" id="order-number">{{ order_number }}</button>
                </div>
                <div class="main__order-header-item">
                    <p>–î–∞—Ç–∞ –≤—Ä–µ–º—è</p>
                    <button class="main__btn-short" id="order-date">{{ current_datetime.strftime('%d.%m.%y') }}</button>
                    <button class="main__btn-short" id="order-time">{{ current_datetime.strftime('%H:%M:%S') }}</button>
                </div>
            </div>
            <div class="main__order-subheader">
                <div class="main__order-subheader-item">
                    <div class="main__subheader-filing">
                        <form action="#">
                            <select name="driver-select" id="driver-select">
                                <option value="" disabled selected>–í–æ–¥–∏—Ç–µ–ª–∏</option>
                                 {% for driver in drivers %}
                                 <option value="{{ driver.id }}" data-tariff="{{ driver.tariff }}">{{ driver.first_name }} {{ driver.last_name }} - {{ driver.phone_number }}</option>
                                 {% endfor %}
                            </select>
                        </form>
                    </div>
                    <div class="main__subheader-filing">
                        <form action="#">
                            <select name="tariff-select" id="tariff-select" title="–¢–∞—Ä–∏—Ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–æ–¥–∏—Ç–µ–ª—è">
                                <option value="" disabled selected>–¢–∞—Ä–∏—Ñ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</option>
                                <option value="–≠–∫–æ–Ω–æ–º">–≠–∫–æ–Ω–æ–º</option>
                                <option value="–ö–æ–º—Ñ–æ—Ä—Ç">–ö–æ–º—Ñ–æ—Ä—Ç</option>
                                <option value="–ë–∏–∑–Ω–µ—Å">–ë–∏–∑–Ω–µ—Å</option>
                            </select>
                        </form>
                    </div>
                    <div class="main__subheader-filing">
                        <form action="#">
                            <select name="payment-select" id="payment-select">
                                <option value="–ù–∞–ª–∏—á–Ω—ã–µ" selected>–ù–∞–ª–∏—á–Ω—ã–µ</option>
                            </select>
                        </form>
                    </div>
                </div>
            </div>
            {% if not drivers %}
            <p style="color: #ff6b6b; margin-top: 10px; font-size: 14px;" id="no-drivers-message">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –ª–∏–Ω–∏–∏</p>
            {% endif %}
            <div class="main__order-details">
                <div class="main__order-details-item main__order-details-where">
                    <input type="text" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" id="client-name" class="main__order-input">
                </div>
                <div class="main__order-details-item main__order-details-whither">
                    <input type="text" placeholder="+996 XXX - XXX - XXX" id="client-phone" class="main__order-input" maxlength="20">
                </div>
            </div>
            <div class="main__order-details">
                <div class="main__order-details-item main__order-details-where">
                    <input type="text" placeholder="–¢–æ—á–∫–∞ –ê (–æ—Ç–∫—É–¥–∞)" id="pickup-address" class="main__order-input">
                </div>
                <div class="main__order-details-item main__order-details-whither">
                    <input type="text" placeholder="–¢–æ—á–∫–∞ –ë (–∫—É–¥–∞)" id="destination-address" class="main__order-input">
                </div>
            </div>
            <div class="main__order-notes">
                <div class="main__order-notes-text">
                    <form>
                        <textarea id="order-notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" class="main__order-input" style="width: 670px;"></textarea>
                    </form>
                </div>
            </div>
            <div class="main__table">
                <table>
                    <thead>
                        <tr>
                            <th>–ó–∞–∫–∞–∑</th>
                            <th>–í—Ä–µ–º—è</th>
                            <th>–û—Ç–∫—É–¥–∞</th>
                            <th>–ö—É–¥–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_orders %}
                            {% for order in recent_orders %}
                            <tr>
                                <td>{{ order.order_number if order.order_number else order.id }}</td>
                                <td>{{ order.created_at.strftime('%H:%M %d.%m.%y') if order.created_at else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                                <td>{{ order.pickup_address if order.pickup_address else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                                <td>{{ order.destination_address if order.destination_address else '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 20px; color: #888;">
                                    –ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="main__order-map">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û –∫–∞—Ä—Ç—É -->
            <div class="main__order-map-item" id="map" style="max-width: 620px; height: 338px;"></div>
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ä—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ -->
            <div class="main__order-map-settings">
                <div class="main__order-map-settings">
                    <button class="main__btn" onclick="resetPoints()">–°–±—Ä–æ—Å–∏—Ç—å —Ç–æ—á–∫–∏</button>
                </div>
                <div class="main__order-map-settings-item">
                    <div class="main__btn-short" id="distance-display">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º</div>
                    <div class="main__btn-short" id="duration-display">–í—Ä–µ–º—è: 0 –º–∏–Ω</div>
                </div>
                <div class="main__order-map-settings-item">
                    <div class="main__btn-short" id="tariff-display">–¢–∞—Ä–∏—Ñ: –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                    <div class="main__btn-short" id="price-display">–¶–µ–Ω–∞: 0 —Å–æ–º</div>
                </div>
            </div>
        </div>
    </div>
    <div class="main__order-wrapper-btn">
        <button class="main__btn-green" onclick="submitOrder()">–ó–∞–∫–∞–∑–∞—Ç—å</button>
        <button class="main__btn" onclick="cancelOrder()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function generateNewOrderNumber() {
        const newOrderNumber = 'WDD10' + Math.floor(Math.random() * 9000000) + 1000000;
        document.getElementById('order-number').textContent = newOrderNumber;
        return newOrderNumber;
    }
    
    function createNewOrder() {
        generateNewOrderNumber();

        const now = new Date();
        document.getElementById('order-date').textContent = now.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: '2-digit' });

         document.getElementById('driver-select').value = '';
         document.getElementById('tariff-select').value = '';
         // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–ø–ª–∞—Ç—É - "–ù–∞–ª–∏—á–Ω—ã–µ" –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω—ã
         document.getElementById('payment-select').value = '–ù–∞–ª–∏—á–Ω—ã–µ';
         document.getElementById('pickup-address').value = '';
         document.getElementById('destination-address').value = '';
         document.getElementById('order-notes').value = '';
         
         // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ñ–æ—Ä–º—ã
         const tariffSelect = document.getElementById('tariff-select');
         if (tariffSelect) {
             tariffSelect.disabled = false;
         }
         
         if (typeof resetPoints === 'function') {
             resetPoints();
         }
         
         // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Ñ–ª–∞–≥–∏ —Ä–∞—Å—á–µ—Ç–æ–≤
         isCalculating = false;
         isRouteCalculated = false;
         isPriceCalculated = false;
         
         // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ —Å–±—Ä–æ—Å–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π
         setTimeout(() => {
             updateOrderButtonState();
         }, 100);
    }
    
    function submitOrder() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–∫–∞–∑
        const orderButton = document.querySelector('.main__btn-green');
        if (orderButton && orderButton.disabled) {
            console.log('–ö–Ω–æ–ø–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –∑–∞–∫–∞–∑ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ A:', pointACoords);
        console.log('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏ B:', pointBCoords);
        
        // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const distanceText = document.getElementById('distance-display').textContent;
        const durationText = document.getElementById('duration-display').textContent;
        const priceText = document.getElementById('price-display').textContent;
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const distance = distanceText ? parseFloat(distanceText.match(/[\d.]+/)?.[0] || 0) : 0;
        const duration = durationText ? parseInt(durationText.match(/\d+/)?.[0] || 0) : 0;
        const price = priceText ? parseFloat(priceText.match(/[\d.]+/)?.[0] || 0) : 0;
        
        const orderData = {
            order_number: document.getElementById('order-number').textContent,
            client_name: document.getElementById('client-name').value || '',
            client_phone: document.getElementById('client-phone').value || '',
            driver_id: document.getElementById('driver-select').value,
            tariff: document.getElementById('tariff-select').value,
            payment_method: document.getElementById('payment-select').value,
            pickup_address: document.getElementById('pickup-address').value,
            pickup_latitude: pointACoords ? pointACoords.latitude : null,
            pickup_longitude: pointACoords ? pointACoords.longitude : null,
            destination_address: document.getElementById('destination-address').value,
            destination_latitude: pointBCoords ? pointBCoords.latitude : null,
            destination_longitude: pointBCoords ? pointBCoords.longitude : null,
            distance: distance,
            duration: duration,
            price: price,
            notes: document.getElementById('order-notes').value || ''
        };
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        if (!orderData.client_name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞');
            return;
        }
        if (!orderData.client_phone) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞');
            return;
        }
        if (!orderData.driver_id) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è');
            return;
        }
        if (!orderData.tariff) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ');
            return;
        }
        if (!orderData.payment_method) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã');
            return;
        }
        if (!orderData.pickup_address) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
            return;
        }
        if (!orderData.destination_address) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
            return;
        }
        if (!orderData.notes) {
            alert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ');
            return;
        }
        if (!pointACoords) {
            alert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ—á–∫—É –ê –Ω–∞ –∫–∞—Ä—Ç–µ');
            return;
        }
        if (!pointBCoords) {
            alert('–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ—á–∫—É –ë –Ω–∞ –∫–∞—Ä—Ç–µ');
            return;
        }
        
        console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:', orderData);
        
        if (confirm('–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑?')) {
            fetch('/disp/api/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ:', data.order);
                    alert(`–ó–∞–∫–∞–∑ ${data.order.order_number} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
                    const orderDetails = `
–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${data.order.order_number}
–í–æ–¥–∏—Ç–µ–ª—å: ${data.order.driver_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
–¢–∞—Ä–∏—Ñ: ${data.order.tariff}
–û–ø–ª–∞—Ç–∞: ${data.order.payment_method}
–û—Ç–∫—É–¥–∞: ${data.order.pickup_address}
–ö—É–¥–∞: ${data.order.destination_address}
–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${data.order.distance || 0} –∫–º
–í—Ä–µ–º—è: ${data.order.duration || 0} –º–∏–Ω
–¶–µ–Ω–∞: ${data.order.price || 0} —Å–æ–º
–°—Ç–∞—Ç—É—Å: ${data.order.status}
                    `;
                    console.log('–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞:', orderDetails);
                    
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                    resetPoints();
                    document.getElementById('client-name').value = '';
                    document.getElementById('client-phone').value = '';
                    document.getElementById('order-notes').value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞
                    generateNewOrderNumber();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞');
            });
        }
    }
    
    function cancelOrder() {
        if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞?')) {
            createNewOrder();
        }
    }
    
    async function updateKyrgyzstanTime() {
        try {
            const response = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=Etc/GMT-6');
            const data = await response.json();
            
            if (data.dateTime) {
                const date = new Date(data.dateTime);
                const timeString = date.toLocaleTimeString('ru-RU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Etc/GMT-6'
                });
                document.getElementById('order-time').textContent = timeString;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', error);
            // Fallback: –≤—ã—á–∏—Å–ª—è–µ–º UTC+6 –≤—Ä—É—á–Ω—É—é
            const now = new Date();
            const kyrgyzstanTime = new Date(now.getTime() + (6 * 60 * 60 * 1000)); // UTC+6
            document.getElementById('order-time').textContent = kyrgyzstanTime.toLocaleTimeString('ru-RU', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }
    }

    updateKyrgyzstanTime(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    setInterval(updateKyrgyzstanTime, 1000);
    

     $(document).ready(function() {
         console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
         console.log('–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: {{ order_number }}');
         console.log('–î–æ—Å—Ç—É–ø–Ω–æ –≤–æ–¥–∏—Ç–µ–ª–µ–π: {{ drivers|length }}');
     });
</script>

<style>
html {
    overflow-y: scroll !important;
}
.main__order-input {
    width: 100%;
    padding: 10px;
    background-color: #47484c;
    border: 1px solid #666;
    border-radius: 4px;
    color: white;
    font-size: 14px;
}

.main__order-input::placeholder {
    color: #999;
}

.main__order-input:focus {
    outline: none;
    border-color: #3b8c4d;
}
.main__order-subheader-item {
    width: 100%;
}
.main__subheader-filing {
    width: 100%;
}
.main__order-subheader-item select {
    width: 100%;
}
 .main__order-header {
     width: 100%;
     justify-content: space-between;
 }

 .main__order-map-settings-item {
    margin: 10px 0;
 }

 #map {
     width: 100%;
     height: 338px;
     border-radius: 5px;
     position: relative;
     overflow: hidden;
 }

 .tariff-active {
     background-color: #3b8c4d !important;
     color: white !important;
 }

 .main__table thead tr th {
     font-size: 13px;
 }
 .main__table tbody td {
     font-size: 12px;
 }

/* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –∑–∞–∫–∞–∑–∞ */
.main__btn-green:disabled {
    background-color: #666 !important;
    color: #999 !important;
    cursor: not-allowed !important;
    opacity: 0.5 !important;
}

.main__btn-green:disabled:hover {
    background-color: #666 !important;
    color: #999 !important;
}
</style>

<script>
    let websocket = null;
    
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/orders/dispatcher`;
        
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = function(event) {
            console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
        };
        
        websocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
        };
        
        websocket.onclose = function(event) {
            console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
            setTimeout(connectWebSocket, 5000);
        };
        
        websocket.onerror = function(error) {
            console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        };
    }
    
    function handleWebSocketMessage(data) {
        console.log('WebSocket —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ:', data);
        
        if (data.type === 'driver_status_changed') {
            console.log('–°—Ç–∞—Ç—É—Å –≤–æ–¥–∏—Ç–µ–ª—è –∏–∑–º–µ–Ω–∏–ª—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫');
            updateDriverList();
        } else if (data.type === 'connection_established') {
            console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            updateDriverList();
        }
    }
    
    async function updateDriverList() {
        try {
            console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π...');
            const response = await fetch('/disp/api/online-drivers');
            const result = await response.json();
            
            console.log('–û—Ç–≤–µ—Ç API:', result);
            
            if (result.success) {
                const driverSelect = document.getElementById('driver-select');
                const currentValue = driverSelect.value;
                
                driverSelect.innerHTML = '<option value="" disabled selected>–í–æ–¥–∏—Ç–µ–ª–∏</option>';
                
                if (result.drivers.length === 0) {
                    console.log('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π');
                    let noDriversMsg = document.getElementById('no-drivers-message');
                    if (!noDriversMsg) {
                        noDriversMsg = document.createElement('p');
                        noDriversMsg.id = 'no-drivers-message';
                        noDriversMsg.style.cssText = 'color: #ff6b6b; margin-top: 10px; font-size: 14px;';
                        noDriversMsg.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –ª–∏–Ω–∏–∏';
                        
                        const subheader = document.querySelector('.main__order-subheader');
                        if (subheader) {
                            subheader.parentNode.insertBefore(noDriversMsg, subheader.nextSibling);
                        }
                    }
                } else {
                    console.log(`–ù–∞–π–¥–µ–Ω–æ ${result.drivers.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π:`, result.drivers);
                    const existingMsg = document.getElementById('no-drivers-message');
                    if (existingMsg) {
                        existingMsg.remove();
                    }
                    
                    result.drivers.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.id;
                        option.setAttribute('data-tariff', driver.tariff);
                        option.textContent = `${driver.first_name} ${driver.last_name} - ${driver.phone_number}`;
                        driverSelect.appendChild(option);
                    });
                    
                    if (currentValue && result.drivers.find(d => d.id == currentValue)) {
                        driverSelect.value = currentValue;
                    }
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π:', error);
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateDriverList();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–æ–¥–∏—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –≤—ã—Å–æ–∫–æ–≥–æ —Å–ø—Ä–æ—Å–∞
        setInterval(updateDriverList, 5000);
    });
</script>
{% endblock %}
