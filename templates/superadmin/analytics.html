{% extends "base.html" %}

{% block title %}Taxi 2.0 - Аналитика{% endblock %}

{% block content %}

<style>
    .table-container {
        padding: 0 !important;
    }
</style>

<div class="p-8">
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Аналитика</h2>
                <p class="text-gray-600">Аналитические данные системы</p>
            </div>
            <div class="flex items-center space-x-4">
                <select id="periodSelect" class="form-input" onchange="loadAnalytics()">
                    <option value="7">Последние 7 дней</option>
                    <option value="30">Последние 30 дней</option>
                    <option value="90">Последние 3 месяца</option>
                    <option value="365">Последний год</option>
                </select>
                <button onclick="loadAnalytics()" class="btn-primary">
                    <i class="ri-refresh-line mr-2"></i>
                    Обновить
                </button>
            </div>
        </div>
    </div>
    
    <!-- Основные метрики -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Общий доход</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalRevenue">-</p>
                    <p class="text-xs text-green-600" id="revenueChange">-</p>
                </div>
                <div class="metric-icon green">
                    <i class="ri-money-dollar-circle-line text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Заказов выполнено</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalOrders">-</p>
                    <p class="text-xs text-blue-600" id="ordersChange">-</p>
                </div>
                <div class="metric-icon blue">
                    <i class="ri-check-line text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Активных водителей</p>
                    <p class="text-2xl font-bold text-gray-900" id="activeDrivers">-</p>
                    <p class="text-xs text-purple-600" id="driversChange">-</p>
                </div>
                <div class="metric-icon purple">
                    <i class="ri-user-line text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Средний чек</p>
                    <p class="text-2xl font-bold text-gray-900" id="averageOrder">-</p>
                    <p class="text-xs text-orange-600" id="averageChange">-</p>
                </div>
                <div class="metric-icon orange">
                    <i class="ri-shopping-cart-line text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Графики -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- График доходов -->
        <div class="table-container">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Динамика доходов</h3>
            </div>
            <div class="p-6">
                <canvas id="revenueChart" class="h-64"></canvas>
            </div>
        </div>
        
        <!-- Статистика по статусам заказов -->
        <div class="table-container">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Статусы заказов</h3>
            </div>
            <div class="p-6">
                <canvas id="ordersStatusChart" class="h-64"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Топ водители на всю ширину -->
    <div class="table-container">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-900">Топ водители</h3>
        </div>
        <div class="p-6">
            <div id="topDrivers" class="space-y-4">
                <div class="text-center py-8">
                    <i class="ri-loader-4-line text-2xl text-gray-400 animate-spin mb-2"></i>
                    <p class="text-gray-500">Загрузка...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let analyticsData = {};
    let revenueChart = null;
    let ordersStatusChart = null;

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('superadmin_access_token');
        if (!token) {
            window.location.href = '/superadmin/login';
            return;
        }
        loadAnalytics();
    });

    async function loadAnalytics() {
        const period = document.getElementById('periodSelect').value;
        
        try {
            const response = await fetch(`/superadmin/api/analytics?period=${period}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('superadmin_access_token')}`
                }
            });

            if (!response.ok) {
                throw new Error('Ошибка загрузки данных');
            }

            analyticsData = await response.json();
            updateMetrics();
            updateCharts();
            updateDetailedStats();
        } catch (error) {
            console.error('Error loading analytics:', error);
            showError('Ошибка загрузки аналитических данных');
        }
    }

    function updateMetrics() {
        // Обновляем основные метрики
        document.getElementById('totalRevenue').textContent = formatCurrency(analyticsData.total_revenue || 0);
        document.getElementById('totalOrders').textContent = analyticsData.total_orders || 0;
        document.getElementById('activeDrivers').textContent = analyticsData.active_drivers || 0;
        document.getElementById('averageOrder').textContent = formatCurrency(analyticsData.average_order || 0);
        
        // Обновляем изменения (пока заглушки)
        document.getElementById('revenueChange').textContent = '+12.5%';
        document.getElementById('ordersChange').textContent = '+8.2%';
        document.getElementById('driversChange').textContent = '+3.1%';
        document.getElementById('averageChange').textContent = '+5.7%';
    }

    function updateCharts() {
        // График доходов
        updateRevenueChart();
        
        // График статусов заказов
        updateOrdersStatusChart();
    }

    function updateRevenueChart() {
        const ctx = document.getElementById('revenueChart');
        if (revenueChart) {
            revenueChart.destroy();
        }
        
        // Используем реальные данные или показываем сообщение об отсутствии данных
        if (!analyticsData.revenue_data || analyticsData.revenue_data.length === 0) {
            ctx.style.display = 'none';
            ctx.parentElement.innerHTML = `
                <div class="h-64 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ri-bar-chart-line text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">Нет данных для отображения</p>
                    </div>
                </div>
            `;
            return;
        }
        
        const data = analyticsData.revenue_data;
        const labels = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
        
        try {
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Доход (руб)',
                        data: data,
                        borderColor: '#048A81',
                        backgroundColor: 'rgba(4, 138, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' руб';
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating revenue chart:', error);
            ctx.parentElement.innerHTML = `
                <div class="h-64 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ri-error-warning-line text-4xl text-red-300 mb-2"></i>
                        <p class="text-red-500">Ошибка загрузки графика</p>
                    </div>
                </div>
            `;
        }
    }

    function updateOrdersStatusChart() {
        const ctx = document.getElementById('ordersStatusChart');
        if (ordersStatusChart) {
            ordersStatusChart.destroy();
        }
        
        // Используем реальные данные
        const data = analyticsData.orders_by_status;
        
        if (!data || (data.completed === 0 && data.cancelled === 0 && data.in_progress === 0 && data.pending === 0)) {
            ctx.style.display = 'none';
            ctx.parentElement.innerHTML = `
                <div class="h-64 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ri-pie-chart-line text-4xl text-gray-300 mb-2"></i>
                        <p class="text-gray-500">Нет данных для отображения</p>
                    </div>
                </div>
            `;
            return;
        }
        
        try {
            ordersStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Выполнено', 'Отменено', 'В процессе', 'Ожидает'],
                    datasets: [{
                        data: [data.completed, data.cancelled, data.in_progress, data.pending],
                        backgroundColor: [
                            '#10B981',
                            '#EF4444',
                            '#F59E0B',
                            '#6B7280'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating orders status chart:', error);
            ctx.parentElement.innerHTML = `
                <div class="h-64 flex items-center justify-center">
                    <div class="text-center">
                        <i class="ri-error-warning-line text-4xl text-red-300 mb-2"></i>
                        <p class="text-red-500">Ошибка загрузки графика</p>
                    </div>
                </div>
            `;
        }
    }

    function updateDetailedStats() {
        // Топ водители
        updateTopDrivers();
    }

    function updateTopDrivers() {
        const container = document.getElementById('topDrivers');
        const drivers = analyticsData.top_drivers || [];
        
        if (drivers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="ri-user-line text-4xl text-gray-300 mb-2"></i>
                    <p class="text-gray-500">Нет данных о водителях</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = drivers.map((driver, index) => `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white text-sm font-bold">
                        ${index + 1}
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-900">${driver.name}</p>
                        <p class="text-xs text-gray-500">${driver.orders} заказов</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-semibold text-gray-900">${formatCurrency(driver.revenue)}</p>
                    <p class="text-xs text-gray-500">доход</p>
                </div>
            </div>
        `).join('');
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 0
        }).format(amount);
    }

    function showError(message) {
        // Показываем ошибку в блоке топ водителей
        const container = document.getElementById('topDrivers');
        if (container) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="ri-error-warning-line text-2xl text-red-400 mb-2"></i>
                    <p class="text-red-500">${message}</p>
                </div>
            `;
        }
    }
</script>
{% endblock %}
