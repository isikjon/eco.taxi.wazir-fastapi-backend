{% extends "base.html" %}

{% block title %}Taxi 2.0 - Администраторы{% endblock %}

{% block content %}
<div class="p-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Администраторы</h2>
            <p class="text-gray-600">Управление администраторами системы</p>
        </div>
        <button onclick="openCreateAdminModal()" class="btn-primary">
            <i class="ri-user-add-line mr-2"></i>
            Добавить администратора
        </button>
    </div>
    
    <!-- Фильтры и статистика -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Всего администраторов</p>
                    <p class="text-2xl font-bold text-gray-900" id="totalAdmins">-</p>
                </div>
                <div class="metric-icon orange">
                    <i class="ri-user-settings-line text-orange-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Фильтр по таксопарку</p>
                    <select id="taxiparkFilter" class="w-full text-sm border border-gray-300 rounded px-2 py-1 mt-2" onchange="filterAdministrators()">
                        <option value="">Все таксопарки</option>
                    </select>
                </div>
                <div class="metric-icon blue">
                    <i class="ri-filter-line text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="table-container">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Список администраторов</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="table-header">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Логин</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Фамилия</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Таксопарк</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата создания</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                    </tr>
                </thead>
                <tbody id="administratorsTableBody" class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Кнопка копирования всех данных -->
    <div class="mt-6 text-center">
        <button onclick="copyAllData()" class="btn-primary">
            <i class="ri-clipboard-line mr-2"></i>
            Скопировать все данные
        </button>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Модальное окно создания администратора -->
<div id="createAdminModal" class="modal-overlay">
    <div class="modal-content">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Добавить нового администратора</h3>
        
        <form id="createAdminForm" class="space-y-4">
            <div>
                <label for="adminLogin" class="form-label">Логин</label>
                <input type="text" id="adminLogin" name="login" required class="form-input" placeholder="Введите логин">
            </div>
            
            <div>
                <label for="adminPassword" class="form-label">Пароль</label>
                <div class="flex space-x-2">
                    <input type="password" id="adminPassword" name="password" required class="form-input flex-1" placeholder="Введите пароль">
                    <button type="button" onclick="togglePasswordVisibility()" class="px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                        <i class="ri-eye-line" id="passwordEyeIcon"></i>
                    </button>
                    <button type="button" onclick="generatePassword()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        <i class="ri-refresh-line"></i>
                    </button>
                </div>
            </div>
            
            <div>
                <label for="adminTaxipark" class="form-label">Таксопарк</label>
                <select id="adminTaxipark" name="taxipark_id" required class="form-input">
                    <option value="">Выберите таксопарк</option>
                </select>
            </div>
            
            <div>
                <label for="adminFirstName" class="form-label">Имя</label>
                <input type="text" id="adminFirstName" name="first_name" required class="form-input" placeholder="Введите имя">
            </div>
            
            <div>
                <label for="adminLastName" class="form-label">Фамилия</label>
                <input type="text" id="adminLastName" name="last_name" required class="form-input" placeholder="Введите фамилию">
            </div>
            
            <div class="flex space-x-3 pt-4">
                <button type="submit" class="flex-1 btn-primary">
                    Создать
                </button>
                <button type="button" onclick="closeCreateAdminModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                    Отмена
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let administratorsData = [];
    let taxiparksData = [];
    let jsonAdminData = []; // Данные из JSON файла

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('superadmin_access_token');
        if (!token) {
            window.location.href = '/superadmin/login';
            return;
        }
        
        loadTaxiparks();
        loadAdministrators();
        loadAdministratorsCount();
        loadJsonAdminData(); // Загружаем данные из JSON
        
        document.getElementById('createAdminForm').addEventListener('submit', handleCreateAdministrator);
    });

    async function loadTaxiparks() {
        try {
            const response = await fetch('/superadmin/api/taxiparks');
            
            if (response.ok) {
                taxiparksData = await response.json();
                updateTaxiparkSelects();
            } else {
                console.error('Failed to load taxiparks:', response.status);
            }
        } catch (error) {
            console.error('Error loading taxiparks:', error);
        }
    }

    async function loadAdministrators(taxiparkId = null) {
        try {
            const url = taxiparkId 
                ? `/superadmin/api/administrators?taxipark_id=${taxiparkId}`
                : '/superadmin/api/administrators';
            
            const response = await fetch(url);
            
            if (response.ok) {
                administratorsData = await response.json();
                updateAdministratorsTable();
            } else {
                console.error('Failed to load administrators:', response.status);
            }
        } catch (error) {
            console.error('Error loading administrators:', error);
        }
    }

    async function loadAdministratorsCount(taxiparkId = null) {
        try {
            const url = taxiparkId 
                ? `/superadmin/api/administrators/count?taxipark_id=${taxiparkId}`
                : '/superadmin/api/administrators/count';
            
            const response = await fetch(url);
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('totalAdmins').textContent = data.count;
            } else {
                console.error('Failed to load administrators count:', response.status);
            }
        } catch (error) {
            console.error('Error loading administrators count:', error);
        }
    }

    async function loadJsonAdminData() {
        try {
            const response = await fetch('/superadmin/api/administrators/json-data');
            
            if (response.ok) {
                const data = await response.json();
                jsonAdminData = data.administrators || [];
            } else {
                console.error('Failed to load JSON admin data:', response.status);
            }
        } catch (error) {
            console.error('Error loading JSON admin data:', error);
        }
    }

    function updateTaxiparkSelects() {
        // Обновляем select в модальном окне
        const adminTaxiparkSelect = document.getElementById('adminTaxipark');
        adminTaxiparkSelect.innerHTML = '<option value="">Выберите таксопарк</option>';
        
        // Обновляем select в фильтрах
        const filterSelect = document.getElementById('taxiparkFilter');
        filterSelect.innerHTML = '<option value="">Все таксопарки</option>';
        
        taxiparksData.forEach(taxipark => {
            const option1 = document.createElement('option');
            option1.value = taxipark.id;
            option1.textContent = taxipark.name;
            adminTaxiparkSelect.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = taxipark.id;
            option2.textContent = taxipark.name;
            filterSelect.appendChild(option2);
        });
    }

    function updateAdministratorsTable() {
        const tbody = document.getElementById('administratorsTableBody');
        tbody.innerHTML = '';
        
        administratorsData.forEach(admin => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${admin.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${admin.login}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${admin.first_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${admin.last_name}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${admin.taxipark_name}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="status-badge ${admin.is_active ? 'active' : 'inactive'}">
                        ${admin.is_active ? 'Активен' : 'Заблокирован'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${admin.created_at ? new Date(admin.created_at).toLocaleDateString('ru-RU') : '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <div class="flex space-x-2">
                        <button onclick="toggleAdminStatus(${admin.id}, ${admin.is_active})" class="${admin.is_active ? 'text-orange-600 hover:text-orange-900' : 'text-green-600 hover:text-green-900'}">
                            <i class="ri-${admin.is_active ? 'pause' : 'play'}-line"></i> ${admin.is_active ? 'Заблокировать' : 'Разблокировать'}
                        </button>
                        <button onclick="copyAdminData(${admin.id})" class="text-blue-600 hover:text-blue-900">
                            <i class="ri-clipboard-line"></i> Копировать
                        </button>
                        <button onclick="deleteAdministrator(${admin.id})" class="text-red-600 hover:text-red-900">
                            <i class="ri-delete-bin-line"></i> Удалить
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function filterAdministrators() {
        const taxiparkId = document.getElementById('taxiparkFilter').value;
        if (taxiparkId) {
            loadAdministrators(parseInt(taxiparkId));
            loadAdministratorsCount(parseInt(taxiparkId));
        } else {
            loadAdministrators();
            loadAdministratorsCount();
        }
    }

    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('adminPassword');
        const eyeIcon = document.getElementById('passwordEyeIcon');
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.className = 'ri-eye-off-line';
        } else {
            passwordInput.type = 'password';
            eyeIcon.className = 'ri-eye-line';
        }
    }

    function generatePassword() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        let password = '';
        for (let i = 0; i < 16; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('adminPassword').value = password;
    }

    function openCreateAdminModal() {
        const modal = document.getElementById('createAdminModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function closeCreateAdminModal() {
        const modal = document.getElementById('createAdminModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.getElementById('createAdminForm').reset();
        // Сбрасываем тип поля пароля
        const passwordInput = document.getElementById('adminPassword');
        passwordInput.type = 'password';
        const eyeIcon = document.getElementById('passwordEyeIcon');
        eyeIcon.className = 'ri-eye-line';
    }

    async function handleCreateAdministrator(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const login = formData.get('login');
        const password = formData.get('password');
        const taxipark_id = parseInt(formData.get('taxipark_id'));
        const first_name = formData.get('first_name');
        const last_name = formData.get('last_name');
        
        try {
            const requestBody = JSON.stringify({ 
                login, 
                password, 
                taxipark_id, 
                first_name, 
                last_name 
            });
            
            const response = await fetch('/superadmin/api/administrators', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: requestBody
            });
            
            if (response.ok) {
                const result = await response.json();
                alert('Администратор успешно создан!');
                closeCreateAdminModal();
                loadAdministrators();
                loadAdministratorsCount();
                loadJsonAdminData(); // Перезагружаем JSON данные
            } else {
                const error = await response.json();
                alert(`Ошибка: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error creating administrator:', error);
            alert('Ошибка при создании администратора');
        }
    }

    async function toggleAdminStatus(adminId, currentStatus) {
        const action = currentStatus ? 'заблокировать' : 'разблокировать';
        if (!confirm(`Вы уверены, что хотите ${action} этого администратора?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/superadmin/api/administrators/${adminId}/toggle-status`, {
                method: 'PUT'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`Администратор успешно ${action}!`);
                loadAdministrators();
                loadAdministratorsCount();
            } else {
                const error = await response.json();
                alert(`Ошибка: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error toggling admin status:', error);
            alert(`Ошибка при ${action} администратора`);
        }
    }

    async function deleteAdministrator(adminId) {
        if (!confirm('Вы уверены, что хотите удалить этого администратора?')) {
            return;
        }
        
        try {
            const response = await fetch(`/superadmin/api/administrators/${adminId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('Администратор успешно удален!');
                loadAdministrators();
                loadAdministratorsCount();
            } else {
                const error = await response.json();
                alert(`Ошибка: ${error.detail}`);
            }
        } catch (error) {
            console.error('Error deleting administrator:', error);
            alert('Ошибка при удалении администратора');
        }
    }

    function copyAdminData(adminId) {
        const admin = administratorsData.find(a => a.id === adminId);
        if (!admin) return;
        
        // Ищем пароль в jsonAdminData
        const password = jsonAdminData.find(jsonAdmin => jsonAdmin.id === adminId)?.password || 'Пароль не сохранен';
        const data = `Login: ${admin.login}\nPassword: ${password}`;
        
        navigator.clipboard.writeText(data).then(() => {
            alert('Данные скопированы в буфер обмена!');
        }).catch(() => {
            // Fallback для старых браузеров
            const textArea = document.createElement('textarea');
            textArea.value = data;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Данные скопированы в буфер обмена!');
        });
    }

    function copyAllData() {
        if (administratorsData.length === 0) {
            alert('Нет данных для копирования!');
            return;
        }
        
        let allData = '';
        administratorsData.forEach(admin => {
            // Ищем пароль в jsonAdminData
            const password = jsonAdminData.find(jsonAdmin => jsonAdmin.id === admin.id)?.password || 'Пароль не сохранен';
            allData += `Login: ${admin.login}\nPassword: ${password}\n\n`;
        });
        
        navigator.clipboard.writeText(allData).then(() => {
            alert('Все данные скопированы в буфер обмена!');
        }).catch(() => {
            // Fallback для старых браузеров
            const textArea = document.createElement('textarea');
            textArea.value = allData;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('Все данные скопированы в буфер обмена!');
        });
    }
</script>
{% endblock %}
